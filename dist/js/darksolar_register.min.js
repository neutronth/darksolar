window.AlertMessageView=Backbone.View.extend({type:"error",icon_lookup:{success:"icon-ok-sign",error:"icon-fire",warning:"icon-exclamation-sign",info:"icon-info-sign","default":"icon-info-sign"},icon:"icon-info-sign",initialize:function(a){$.extend(this,a);this.render()},render:function(){this.type=this.type=="error"?"danger":this.type;this.icon=this.icon_lookup[this.type]?this.icon_lookup[this.type]:this.icon_lookup["default"];$(this.el).html(this.template(this));$(this.el).i18n();var a=$(".alert",this.$el);a.addClass("alert-"+this.type);a.alert();var b=setTimeout(function(){a.alert("close")},3e3)}});window.AlertErrorFocus=function(a){$("p.help-block[data-error]",a).each(function(a){var b=$(this);if(b.html()!=""){var c=$(":input",b.parent());if(c)c.focus();return false}})};var dateFormat=function(){var a=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,b=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,c=/[^-+\dA-Z]/g,d=function(a,b){a=String(a);b=b||2;while(a.length<b)a="0"+a;return a};return function(e,f,g){var h=dateFormat;if(arguments.length==1&&Object.prototype.toString.call(e)=="[object String]"&&!/\d/.test(e)){f=e;e=undefined}e=e?new Date(e):new Date;if(isNaN(e))throw SyntaxError("invalid date");f=String(h.masks[f]||f||h.masks["default"]);if(f.slice(0,4)=="UTC:"){f=f.slice(4);g=true}var i=g?"getUTC":"get",j=e[i+"Date"](),k=e[i+"Day"](),l=e[i+"Month"](),m=e[i+"FullYear"](),n=e[i+"Hours"](),o=e[i+"Minutes"](),p=e[i+"Seconds"](),q=e[i+"Milliseconds"](),r=g?0:e.getTimezoneOffset(),s={d:j,dd:d(j),ddd:h.i18n.dayNames[k],dddd:h.i18n.dayNames[k+7],m:l+1,mm:d(l+1),mmm:h.i18n.monthNames[l],mmmm:h.i18n.monthNames[l+12],yy:String(m).slice(2),yyyy:m,h:n%12||12,hh:d(n%12||12),H:n,HH:d(n),M:o,MM:d(o),s:p,ss:d(p),l:d(q,3),L:d(q>99?Math.round(q/10):q),t:n<12?"a":"p",tt:n<12?"am":"pm",T:n<12?"A":"P",TT:n<12?"AM":"PM",Z:g?"UTC":(String(e).match(b)||[""]).pop().replace(c,""),o:(r>0?"-":"+")+d(Math.floor(Math.abs(r)/60)*100+Math.abs(r)%60,4),S:["th","st","nd","rd"][j%10>3?0:(j%100-j%10!=10)*j%10]};return f.replace(a,function(a){return a in s?s[a]:a.slice(1,a.length-1)})}}();dateFormat.masks={"default":"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"};dateFormat.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"]};Date.prototype.format=function(a,b){return dateFormat(this,a,b)};window.production=1;window.darksolar_settings={portalUrl:"http://www.rahunas.org"};var consoleOff=function(){this.log=function(){};this.info=function(){};this.warn=function(){};this.error=function(){};this.assert=function(){}};window.debug=!production?console:new consoleOff;window.intervalFetch=[];window.templateLoader={load:function(a,b){var c=[];$.each(a,function(a,b){if(window[b]){c.push($.get("/tpl/"+b+".html",function(a){window[b].prototype.template=_.template(a)},"html"))}else{debug.warn(b+" not found")}});$.when.apply(null,c).done(b)}};window.BackboneCustomModel=Backbone.Model.extend({get:function(a){this._escapedAttributes=_.clone(this.attributes);this.htmlEscape(this._escapedAttributes);var b;if(this._escapedAttributes!=null){if(b=this._escapedAttributes[a])return b}var c=this.attributes[a];if(c==undefined)return c;if(typeof c=="string"){return this._escapedAttributes[a]=_.escape(c==null?"":""+c)}else{return this._escapedAttributes[a]=c}},htmlEscape:function(a){for(var b in a){if(typeof a[b]=="string"){var c=a[b];a[b]=_.escape(c==null?"":""+c)}else if(typeof a[b]=="object"){this.htmlEscape(a[b])}}},toJSON:function(a){this._escapedAttributes=_.clone(this.attributes);this.htmlEscape(this._escapedAttributes);return _.clone(this._escapedAttributes)}});window.BackboneCustomPaginator=Backbone.Paginator.requestPager.extend({fetch:function(a){this.trigger("fetch:started");Backbone.Collection.prototype.fetch.call(this,a)}});window.navbarTrack=function(a,b){var c=$(".navbar.navbar-fixed-top");var d=Backbone.history.fragment.split("/");var e=d[0];if(e!=undefined){var f=$("li",c);var g=e.split("/")[0];f.each(function(a,b){var c=$(b);var d=$(c.children()[0]);if(!c.hasClass("nav-skip")){var e=d.attr("href").split(/\/#\/|\//)[1];debug.log(e,g);if(e==g){c.addClass("active")}else{c.removeClass("active")}}})}};window.User=BackboneCustomModel.extend({urlRoot:"/api/user/changepassword",bypassUserCheck:false,idAttribute:"_id",schema:{username:{type:"Text",title:"user:form.Username",validators:["required"]},current_password:{type:"Password",title:"user:form.Current Password",validators:["required"]},password:{type:"Password",title:"user:form.Password",validators:[{type:"match",field:"password_confirm",message:function(){return $.t("forms:validation.Passwords must match!")}}]},password_confirm:{type:"Password",title:"user:form.Confirm"}},validate:function(a){var b={};var c=this;if(this.isNew()){if(a.password=="")b.password=$.t("forms:validation.Required")}if(a.password!=""&&a.password.length<6){b.password=$.t("forms:validation.At least 6 characters length")}function d(a,b){var d=$.t("forms:validation.Username does not exist");if(c.bypassUserCheck||c.get("_id")!=undefined){return}$.ajax({url:"/api/user/check/"+a,dataType:"json",async:false,success:function(a){if(a.username==undefined){b.username=d}},error:function(a){b.username=d}})}d(a.username,b);if(!_.isEmpty(b))return b}});window.UserFormView=Backbone.View.extend({initialize:function(a){$.extend(this,a);if(!this.model)this.newModel();this.initEvents();this.initModel()},initEvents:function(){},initModel:function(){var a=this;this.model.on("change",function(){a.isChanges=1})},createForm:function(){var a=[{legend:$.t("user:form.Profile"),fields:["username","current_password"]},{legend:$.t("user:form.New Password"),fields:["password","password_confirm"]}];this.form=new Backbone.Form({model:this.model,fieldsets:a});debug.log(this.form);this.form.render();if(!this.model.isNew()){var b=$('input[name="username"]',this.form.$el);b.parent().html('        <span class="uneditable-input">'+b.val()+"</span>")}},render:function(){$(this.el).html("");this.createForm();$(this.el).append('<div class="form-area"></div>');var a=$(".form-area",this.$el);a.html(this.form.el);$(this.el).append('      <div class="notification-area h4"></div>    ');$(this.el).append('      <div class="form-actions">        <button class="btn btn-primary" id="registersave"><span class="glyphicon glyphicon-ok"></span> <span data-i18n="app:button.ok">OK</span></button>      </div>');this.$el.i18n();return this},events:{"click #registersave":"saveChanges","click #gotologin":function(){$(location).attr("href",darksolar_settings.portalUrl)},"keypress [id$=username]":"usernameCheck","keypress [id$=accesscode]":"accessCodeCheck","blur [id$=accesscode]":"accessCodeAdjust"},newModel:function(){if(this.model)delete this.model;this.model=new User;this.initModel();this.isChanges=0;if(this.targetView)this.targetView.render()},saveChanges:function(){var a=this.form;var b=this.model;var c={};var d=this;if(!this.model.isNew()){d.notify("Could not change any data","error");return this}err=this.form.commit({validate:true});if(!err){debug.info("New: %i",this.model.isNew());this.model.bypassUserCheck=true;if(!this.model.isNew()){if(!this.isChanges){this.notify("Nothing changes","warning");return this}}this.model.save(c,{wait:true,success:function(b,c){debug.info("Success: Saved");var e=$('input[name="username"]',a.$el);e.parent().html('            <span class="uneditable-input">'+e.val()+"</span>");d.isChanges=0;d.notify($.t("user:message.User has been saved"),"success");d.model.bypassUserCheck=false;$("#registersave").attr("disabled",true);var f=$(".form-actions");f.append('<button class="btn btn-success" id="gotologin"><span class="glyphicon glyphicon-user icon-white"></span> <span data-i18n="app:button.Goto login page">Goto login page</span></button>');f.i18n()},error:function(a,b){debug.error(b);debug.error(b.responseText);d.notify($.t("user:message.User save failed:")+" "+b.responseText,"error");d.model.bypassUserCheck=false}})}else{this.notify($.t("app:message.Invalid data"),"error");AlertErrorFocus(this.form.$el)}},notify:function(a,b){var c=$(".notification-area",this.$el);var d=new AlertMessageView({message:a,type:b});c.append(d.el)},usernameCheck:function(a){if(a.charCode==0)return;var b=/[a-z0-9_-]/;var c=String.fromCharCode(a.charCode);if(!b.test(c))a.preventDefault()},accessCodeCheck:function(a){if(a.charCode==0)return;var b=/[0-9]/;var c=String.fromCharCode(a.charCode);if(!b.test(c))a.preventDefault()},accessCodeAdjust:function(a){var b=$(a.currentTarget);var c=b.val().replace(/\s+/g,"");b.val(c)}});window.DarkSolar={};window.Router=Backbone.Router.extend({routes:{"":"password"},initialize:function(){},password:function(){var a=new UserFormView;$("#content").html(a.render().el)}});templateLoader.load(["AlertMessageView"],function(){app=new Router;Backbone.history.start()});if(production){Backbone.debug.off()}else{Backbone.debug.on()}DarkSolar.formValidatorsTranslation=function(){Backbone.Form.validators.errMessages.required=$.t("forms:validation.Required");Backbone.Form.validators.errMessages.regexp=$.t("forms:validation.Invalid");Backbone.Form.validators.errMessages.email=$.t("forms:validation.Invalid email address");Backbone.Form.validators.errMessages.match=_.template($.t("forms:validation.Must match field")+' "<%= field %>"',null,Backbone.Form.templateSettings)};