var consoleOff=function(){this.log=function(){};this.info=function(){};this.warn=function(){};this.error=function(){};this.assert=function(){}};window.debug=!production?console:new consoleOff;window.intervalFetch=[];window.templateLoader={load:function(a,b){var c=[];$.each(a,function(a,b){if(window[b]){c.push($.get("/tpl/"+b+".html",function(a){window[b].prototype.template=_.template(a)},"html"))}else{debug.warn(b+" not found")}});$.when.apply(null,c).done(b)}};window.BackboneCustomModel=Backbone.Model.extend({get:function(a){this._escapedAttributes=_.clone(this.attributes);this.htmlEscape(this._escapedAttributes);var b;if(this._escapedAttributes!==null){if(b==this._escapedAttributes[a])return b}var c=this.attributes[a];if(c===undefined)return c;if(typeof c=="string"){return this._escapedAttributes[a]=_.escape(c===null?"":""+c)}else{return this._escapedAttributes[a]=c}},htmlEscape:function(a){for(var b in a){if(typeof a[b]=="string"){var c=a[b];a[b]=_.escape(c===null?"":""+c)}else if(typeof a[b]=="object"){this.htmlEscape(a[b])}}},toJSON:function(a){this._escapedAttributes=_.clone(this.attributes);this.htmlEscape(this._escapedAttributes);return _.clone(this._escapedAttributes)}});window.BackboneCustomPaginator=Backbone.Paginator.requestPager.extend({fetch:function(a){this.trigger("fetch:started");Backbone.Collection.prototype.fetch.call(this,a)}});window.navbarTrack=function(a,b){var c=$(".navbar.navbar-fixed-top");var d=Backbone.history.fragment.split("/");var e=d[0];if(e!==undefined){var f=$("li",c);var g=e.split("/")[0];f.each(function(a,b){var c=$(b);var d=$(c.children()[0]);if(!c.hasClass("nav-skip")){var e=d.attr("href").split(/\/#\/|\//)[1];debug.log(e,g);if(e==g){c.addClass("active")}else{c.removeClass("active")}}})}};window.AlertMessageView=Backbone.View.extend({type:"error",icon_lookup:{success:"icon-ok-sign",error:"icon-fire",warning:"icon-exclamation-sign",info:"icon-info-sign","default":"icon-info-sign"},icon:"icon-info-sign",initialize:function(a){$.extend(this,a);this.render()},render:function(){this.type=this.type=="error"?"danger":this.type;this.icon=this.icon_lookup[this.type]?this.icon_lookup[this.type]:this.icon_lookup["default"];$(this.el).html(this.template(this));$(this.el).i18n();var a=$(".alert",this.$el);a.addClass("alert-"+this.type);a.alert();var b=setTimeout(function(){a.alert("close")},3e3)}});window.AlertView=Backbone.View.extend({serverity:"warning",data_i18n:"",message:"",initialize:function(a){$.extend(this,a);this.render()},render:function(a){$(this.el).html('<div class="alert alert-'+this.serverity+'" '+'style="text-align: center; margin: 10px;" data-i18n="'+this.data_i18n+'">'+this.message+"</div>");$(this.el).i18n();return this}});window.AlertNoDataView=AlertView.extend({initialize:function(){this.serverity="warning";this.data_i18n="app:message.No data";this.message="No data";this.render()}});window.AlertCouldNotGetDataView=AlertView.extend({initialize:function(){this.serverity="danger";this.data_i18n="app:message.Could not get data";this.message="Could not get data";this.render()}});window.AlertErrorFocus=function(a){$("p.help-block[data-error]",a).each(function(a){var b=$(this);if(b.html()!==""){var c=$(":input",b.parent());if(c)c.focus();return false}})};window.TableBody={apply:function(a){var b=$(window).width();if(b>960){var c=$("tbody",a);var d=$("thead",a);var e=$("#pagination",a);var f=$("#bottomtoolbar");var g=$(window).height();var h=c.offset().top-$(window).scrollTop();var i=d.width();var j=f!==undefined?f.height():0;var k=e.height()+30;var l=g-h-j-k;$("tbody",this.$el).css("height",l).css("width",i-10).css("z-index",1);e.css("padding-top",l+5)}}};window.ForceLogoutModalView=Backbone.View.extend({initialize:function(a){$.extend(this,a);this.render()},events:{"click button#modalConfirm":"onClickConfirm"},render:function(){$(this.el).html(this.template(this));$(this.el).i18n();this.$el.modal({show:false,backdrop:"static"});return this},show:function(){$("#forcelogout_modal").modal("show")},onClickConfirm:function(){window.location="/logout"}});window.ConfirmModalView=Backbone.View.extend({modal_id:"modal",modal_header:"",modal_body:"",initialize:function(a){this.modal_header='<h2 data-i18n="app:message.Are you sure ?">Are you sure ?</h2>';this.modal_body='<p><span data-i18n="app:message.The delete operation could not be undone">The "delete" operation could not be undone</span></p><p><span data-i18n="app:message.please confirm your intention">please confirm your intention.</span></p>';$.extend(this,a);this.render()},events:{"click button#modalCancel":"onClickCancel","click button#modalConfirm":"onClickConfirm"},render:function(){$(this.el).html(this.template(this));$(this.el).i18n();this.$el.modal({show:false,backdrop:"static"});return this},show:function(){$("#confirmmodal_"+this.modal_id).modal("show")},onClickCancel:function(){$("#confirmmodal_"+this.modal_id).modal("hide")},onClickConfirm:function(){$("#confirmmodal_"+this.modal_id).modal("hide");$("body").removeClass("modal-open");$(".modal-backdrop").remove();this.targetView.trigger(this.confirm_trigger)}});window.MenuView=Backbone.View.extend({tagName:"ul",className:"sidebar-menu",menuList:{},iconList:[],initialize:function(){this.render()},rendertreeview:function(a,b,c){var d=typeof b;if(d=="object"){for(var e in b){var f=b[e];var g=typeof f;var h=e;var i=a+"/"+e;var j="fa fa-folder-o";if(this.iconList.hasOwnProperty(i)){j=this.iconList[i]}if(g=="object"){var k=new MenuViewTreeView({label:h,path:i,icon:j});c.append(k.el);this.rendertreeview(i,f,k.getTree())}else if(g=="string"){c.append(new MenuViewMenuItem({label:h,link:f,path:i,icon:j}).el)}}}},rendermenu:function(){this.$el.html("");for(var a in this.menuList){var b=this.menuList[a];this.$el.append("<li class='header'><span data-i18n='nav:"+a+"'>"+a+"</span></li>");this.rendertreeview(a,b,this.$el)}},render:function(){this.rendermenu();$("#mainmenu").html("");$("#mainmenu").append(this.$el);this.$el.i18n();this.updatePageHeader(this.readCookie("current-path"));if($.AdminLTE!==undefined){$.AdminLTE.tree(".sidebar")}$(".menuitem",this.$el).click($.proxy(this.clickInvoked,this))},add:function(a,b,c){this.iconList[a]=c;var d=a.split("/");var e=this.menuList;debug.log("Path: ",d);for(var f=0;f<d.length;f++){var g=d[f];if(!e.hasOwnProperty(g)){e[g]=""}if(f<d.length-1){if(typeof e[g]=="string")e[g]={}}else if(typeof e[g]!="object"){e[g]=b}e=e[g]}this.render()},clickInvoked:function(a){var b=$(a.target);while(!b.hasClass("menuitem"))b=b.parent();var c=b.attr("data-path");this.createCookie("current-path",c,"");this.updatePageHeader(c)},updatePageHeader:function(a){if(!a)return;var b=$("#page_header");var c="<span data-i18n='nav:"+a+"'></span>";b.html(c);b.i18n();this.updateBreadCrumb(a)},updateBreadCrumb:function(a){if(!a)return;var b=a.split("/");var c="";var d="";for(var e=0;e<b.length;e++){d+=b[e];var f="fa fa-folder-o";if(this.iconList.hasOwnProperty(d)){f=this.iconList[d]}var g="<span class='"+f+"' style='margin-right: 5px;'></span> ";var h="<span data-i18n='nav:"+d+"'></span>";c+="<li>"+g+h+"</li>";d+="/"}var i=$("#page_breadcrumb");i.html(c);i.i18n()},createCookie:function(a,b,c){var d="";if(c){var e=new Date;e.setTime(e.getTime()+c*24*60*60*1e3);d="; expires="+e.toGMTString()}document.cookie=a+"="+b+d+"; path=/"},readCookie:function(a){var b=a+"=";var c=document.cookie.split(";");for(var d=0;d<c.length;d++){var e=c[d];while(e.charAt(0)==" ")e=e.substring(1,e.length);if(e.indexOf(b)===0)return e.substring(b.length,e.length)}return null},eraseCookie:function(a){this.createCookie(a,"",-1)}});window.MenuViewTreeView=Backbone.View.extend({tagName:"li",className:"treeview",label:"",initialize:function(a){$.extend(this,a);return this.render()},render:function(){var a="<span class='"+this.icon+"' style='font-size: 20px;margin-right: 8px;'></span> ";var b="<span data-i18n='nav:"+this.path+"'>"+this.label+"</span>";this.$el.append("<a href='#'>"+a+b+"<i class='fa fa-angle-left pull-right'></i></a>");this.$el.append("<ul class='treeview-menu'></ul>");return this},getTree:function(){return $("ul",this.$el)}});window.MenuViewMenuItem=Backbone.View.extend({tagName:"li",icon:"",label:"",link:"",path:"",initialize:function(a){$.extend(this,a);return this.render()},render:function(){var a="<span class='"+this.icon+"'></span> ";var b="<span data-i18n='nav:"+this.path+"'>"+this.label+"</span>";this.$el.append("<a href='"+this.link+"' class='menuitem' data-path='"+this.path+"'>"+a+b+"</a>");return this}});window.SubNavView=Backbone.View.extend({zindex:0,initialize:function(){this.render()},render:function(){$(this.el).html("");$("#dssubnav-toggle").show();if(this.zindex===0){this.zindex=parseInt($("#dssubnav").css("z-index"))}var a=this;$("#mainnav #top_nav").children().on("click",function(a){a.stopPropagation()});$("#dssubnav").children().on("click",function(a){a.stopPropagation()})}});window.SubNavItemView=Backbone.View.extend({tagName:"li",initialize:function(a){$.extend(this,a);this.render()},render:function(){var a=this.data.link.split("/#/");var b=a[1];if(b!==undefined){var c=Backbone.history.fragment;if(c==b){this.$el.addClass("active")}var d=a[1].split("/");if(d[0]!==undefined)this.data.i18n_name="nav:"+d[0];if(d[1]!==undefined)this.data.i18n_name+="_"+d[1]}$(this.el).html(this.template(this.data));$(this.el).i18n()}});window.Paginator=Backbone.View.extend({className:"btn-group",pageName:"paging",perPage:10,initialize:function(a){$.extend(this,a);this.model.bind("reset",this.render,this);this.render()},events:{"click button[class!='btn btn-primary']":"onClick"},render:function(){var a=this.model;$(this.el).html('<div class="btn-group" id="pagination" style="margin-top: 10px"></div>');var b=Math.floor(a.currentPage/this.perPage);var c=b*this.perPage;var d=c+this.perPage;d=d>a.totalPages?a.totalPages:d;if(c>0){$("#pagination",this.$el).append('          <button class="btn btn-default" id="skip_first_'+this.pageName+'"><span class="fa fa-angle-double-left"></span></button>');$("#pagination",this.$el).append('          <button class="btn btn-default" id="skip_prev_'+this.pageName+'"><span class="fa fa-angle-left"></span></button>')}for(var e=c;e<d;e++){var f=a.currentPage==e?"btn-primary":"btn-default";$("#pagination",this.$el).append('          <button class="btn '+f+'" id="'+this.pageName+"_"+(e+1)+'">'+(e+1)+"</button>")}if(d<a.totalPages){$("#pagination",this.$el).append('          <button class="btn btn-default" id="skip_next_'+this.pageName+'"><span class="fa fa-angle-right"></span></button>');$("#pagination",this.$el).append('          <button class="btn btn-default" id="skip_last_'+this.pageName+'"><span class="fa fa-angle-double-right"></span></button>')}$("#pagination",this.$el).find("button").css("padding-left","12px").css("padding-right","12px").css("padding-top","7px").css("padding-bottom","7px");var g=this;$("#pagination",this.$el).find('button[id^="skip"]').css("padding-left","12px").css("padding-right","12px").css("padding-top","7px").css("padding-bottom","7px").click(function(b){var e=$(b.target,b.delegateTarget);var f=/next/;var h=/prev/;var i=/first/;var j=/last/;var k=e.attr("id");if(f.test(k)){e.text(d+1)}else if(h.test(k)){e.text(c)}else if(j.test(k)){e.text(a.totalPages)}else{e.text("1")}g.onClick(b)});return this},onClick:function(a){$("button",a.delegateTarget).removeClass("btn-primary");$(a.target,a.delegateTarget).addClass("btn-primary")}});window.DSSpinner=Backbone.View.extend({className:"DSSpinner",spinner_html:"<span class='fa fa-spin fa-spinner'></span>",initialize:function(a){$.extend(this,a);this.render()},render:function(){$(this.el).html("")},spin:function(){$(this.el).html(this.spinner_html)},stop:function(){setTimeout($.proxy(function(){$(this.el).html("")},this),100)}});window.SearchToolbarView=Backbone.View.extend({delete_confirm_modal:{},initialize:function(a){$.extend(this,a);this.defaultSettings()},defaultSettings:function(a){this.settings={idPrefix:"",searchable:false,btnNew:false,btnDelete:false};if(a)$.extend(this.settings,a);this.initEvents()},initEvents:function(){this.on("delete_confirm",this.onDeleteConfirm,this)},events:{"click button#search":"onClickSearch","click button#reset":"onClickReset","click button#new":"onClickNew","click button#delete":"onClickDelete"},render:function(a){$(this.el).html(this.template(this.settings));if(this.searchTxt){var b=$('input[type="text"]',this.$el);b.val(this.searchTxt)}var b=$('input[type="text"]',this.$el);b.click(function(a){this.select()});b.keyup(function(a){if(a.keyCode==13){$("#search",this.$el).click()}});this.delete_confirm_modal=new ConfirmModalView({modal_id:"delete",confirm_trigger:"delete_confirm",targetView:this});$(this.delete_confirm_modal.el).i18n();$(this.el).i18n();return this},onClickSearch:function(){var a=$('input[type="text"]',this.$el);debug.log("Search",a.val());this.targetView.trigger("search",a.val())},onClickReset:function(){var a=$('input[type="text"]',this.$el);a.val("");debug.log("Reset");this.targetView.trigger("search",a.val())},onClickNew:function(){this.targetFormView.trigger(this.settings.idPrefix+"new")},showConfirm:function(){$("#modal-area-confirmation").html(this.delete_confirm_modal.el);this.delete_confirm_modal.show()},onClickDelete:function(){if(this.targetFormView.model.isNew()){this.targetFormView.notify($.t("app:message.Nothing deleted"),"warning");return}this.showConfirm()},onDeleteConfirm:function(){this.targetFormView.trigger(this.settings.idPrefix+"delete")}});window.MainToolbarView=Backbone.View.extend({tagName:"div",className:"main-toolbar",initialize:function(a){$.extend(this,a);this.defaultSettings()},defaultSettings:function(a){this.settings={idPrefix:"",btnSave:false,btnCancel:false};if(a)$.extend(this.settings,a)},events:{"click button#save":"onClickSave","click button#cancel":"onClickCancel"},render:function(){$(this.el).html(this.template(this.settings));$(this.el).i18n();return this},onClickSave:function(){this.targetView.trigger("save")},onClickCancel:function(){this.targetView.trigger("cancel")}});window.icheck_settings={checkboxClass:"icheckbox_flat-blue",radioClass:"iradio_flat-blue"};window.MonitorHostView=Backbone.View.extend({netlist:[],initialize:function(a){$.extend(this,a);this.render()},events:{"shown.bs.tab [data-toggle='tab']":"tabChange"},tabChange:function(a){var b=$(a.target).attr("aria-controls");var c=b.replace("mon_net_","");var d=this.netlist[c];if(d!==undefined){d.updateGraph()}},render:function(){$(this.el).html(this.template(this));_.each(this.networks,$.proxy(function(a){var b=$("#mon_net_"+this.host+"_"+a,this.$el);var c=this.host+"_"+a;var d=new MonitorNetworkView({name:c,host:this.host,network:a});this.netlist[c]=d;b.html(this.netlist[c].el)},this));return this}});window.MonitorNetworkView=Backbone.View.extend({summary_network:false,initialize:function(a){$.extend(this,a);if(this.network=="summary"){this.summary_network=true}this.render()},render:function(){$(this.el).html(this.template(this));return this},updateGraph:function(){var a="/data/"+this.host;var b=this.network.lastIndexOf("-");var c=b>0?this.network.substr(0,b):this.network;var d=b>0?this.network.substr(b+1):"LAN";var e=new ChartOnlineUsers({title:"Online Users - "+c.toUpperCase(),name:this.name+"_dash-onlineuserschart",chart_data:a+"/onlineusers-"+c+".json",onlineCountRenderTo:"#"+this.name+"_dash-onlineusers-count",colors:["#008800"]});container=$("#"+this.name+"_dash-onlineuserschart-container",this.$el);container.html(e.render().el);e.plot();if(!this.summary_network){var f=new ChartTrafficView({title:"Traffic - "+d.toUpperCase(),name:this.name+"_dash-trafficlan",chart_data:a+"/traffic-"+c+".json"});container=$("#"+this.name+"_dash-trafficlan-container",this.$el);container.html(f.render().el);f.plot()}else{var g=new ChartTrafficView({title:"Traffic - WAN",name:this.name+"_dash-trafficwan",chart_data:a+"/traffic-wan.json"});container=$("#"+this.name+"_dash-trafficwan-container",this.$el);container.html(g.render().el);g.plot();var f=new ChartTrafficView({title:"Traffic - LAN",name:this.name+"_dash-trafficlan",chart_data:a+"/traffic-lan.json"});container=$("#"+this.name+"_dash-trafficlan-container",this.$el);container.html(f.render().el);f.plot()}var h=this.summary_network;$("#"+this.name+"_dash-period").change(function(){var a=$(this);var b=a.val();var c=a.find("option:selected").text();c=c=="Day"?"":" - "+c;e.options.chart_data=e.options.chart_data_prefix+b+".json";e.highchart.setTitle({text:e.options.title_prefix+c});e.plot();if(h){g.options.chart_data=g.options.chart_data_prefix+b+".json";g.highchart.setTitle({text:g.options.prefix+c});g.plot()}f.options.chart_data=f.options.chart_data_prefix+b+".json";f.highchart.setTitle({text:f.options.title_prefix+c});f.plot()})}});window.MonitorHostContentView=Backbone.View.extend({host:"host",networks:[],initialize:function(a){$.extend(this,a);this.render()},render:function(){$(this.el).html(_.template("<div role='tabpanel' class='tab-pane' id='host_content_<%= host %>'></div>",this));var a=$("#host_content_"+this.host,this.$el);var b=new MonitorHostView({host:this.host,networks:this.networks});a.append(b.el);return this},showFirstTab:function(){$("#mon_net_"+this.host+"_tabpanel a:first").tab("show")}});window.DashboardView=Backbone.View.extend({hostlist:[],initialize:function(){debug.info("Initializing Dashboard View")},events:{"shown.bs.tab [data-toggle='tab']":"tabChange"},tabChange:function(a){var b=$(a.target).attr("aria-controls")},render:function(){$(this.el).html(this.template({hosts:[]}));$.ajax({url:"/api/monitor/hosts"}).done($.proxy(function(a){$(this.el).html(this.template({hosts:Object.keys(a)}));for(var b in a){var c=new MonitorHostContentView({host:b,networks:["summary"].concat(a[b])});this.hostlist.push(c);$("#"+b,this.$el).append(c.el)}this.showFirstTab()},this));return this},showFirstTab:function(){$("#dash_tabpanel a:first").tab("show");for(var a=this.hostlist.length-1;a>=0;a--){this.hostlist[a].showFirstTab()}}});ManagementUtils=function(){};window.ManagementGroupView=Backbone.View.extend({initialize:function(){this.ManagementUtils=new ManagementUtils},events:{"click a#goback-btn":"gobackPane"},render:function(){$(this.el).html("");$(this.el).append(this.template());this.$el.i18n();return this},gobackPane:function(){$(".tab-pane",this.$el).removeClass("in active");var a=$(".tab-pane:first",this.$el);a.addClass("in active").children().trigger("active_pane")}});window.ManagementGroupFormView=Backbone.View.extend({initialize:function(a){$.extend(this,a);this.ManagementUtils=new ManagementUtils;if(!this.model)this.newModel();this.initEvents();this.initModel()},initEvents:function(){this.on("mgselected",function(a){this.model=a;this.initModel.call(this);this.isChanges=0;this.render()},this);this.on("mgmodify",function(a){this.model=a;this.initModel.call(this);this.isChanges=0;this.render();this.activateFormPane.call(this)},this);this.on("mgnew",function(){this.newModel();this.render();this.activateFormPane.call(this)},this);this.on("mgdelete",function(){var a=this;this.model.destroy({wait:true,success:function(b,c){debug.info("Success: Deleted");a.targetView.trigger("mgdeleted");a.notify($.t("management:message.Management has been deleted"),"success")},error:function(b,c){debug.error("Failed Delete: ",c.responseText);a.notify($.t("management:message.Could not delete management group")+": "+c.responseText,"error")}})},this);this.on("save",this.saveChanges,this);this.on("cancel",this.cancel,this)},initModel:function(){var a=this;this.model.on("change",function(){a.isChanges=1})},activateFormPane:function(){var a=this.$el.parentsUntil(".tab-content-root");var b=this.$el.parentsUntil(".tab-content");$(".tab-pane",a).removeClass("in active");$(b).addClass("in active")},setTargetView:function(a){this.targetView=a},createForm:function(){this.form=new Backbone.Form({model:this.model,fieldsets:[{legend:$.t("management:form.Profile"),fields:["groupname","description","groupstatus"]},{legend:$.t("management:form.Members"),fields:["members"]}]}).render();if(!this.model.isNew()){var a=$('input[name="groupname"]',this.form.$el);a.parent().html('        <span class="uneditable-input">'+a.val()+"</span>")}},render:function(){$(this.el).html("");$(this.el).append(new ManagementGroupToolbarView({targetView:this}).el);this.createForm();$(this.el).append('<div class="form-area"></div>');var a=$(".form-area",this.$el);a.html(this.form.el);$("input",this.form.$el).iCheck(window.icheck_settings);$(this.el).i18n();$("form",this.$el).on("click",this.updateModalI18n);return this},updateModalI18n:function(a){if(!$(a.target).hasClass("bbf-add")&&!$(a.target).hasClass("bbf-list-modal")){return}var b=[200,500,1e3];for(var c=0;c<b.length;c++){setTimeout(function(){$(".modal",$("body")).i18n()},b[c])}},events:{"keypress [id$=groupname]":"groupnameCheck"},groupnameCheck:function(a){if(a.charCode===0)return;var b=/[ a-zA-Z0-9_-]/;var c=String.fromCharCode(a.charCode);if(!b.test(c))a.preventDefault()},newModel:function(){if(this.model)delete this.model;this.model=new ManagementGroup;this.initModel();this.isChanges=0;if(this.targetView)this.targetView.render()},saveChanges:function(){var a=this.form;var b=this.model;var c={};err=this.form.commit({validate:true});if(!err){debug.info("New: %i",this.model.isNew());if(!this.model.isNew()){if(!this.isChanges){this.notify($.t("app:message.Nothing changes"),"warning");return this}}var d=this;this.model.save(c,{wait:true,success:function(b,c){debug.info("Success: Saved");var e=$('input[name="groupname"]',a.$el);e.parent().html('            <span class="uneditable-input">'+e.val()+"</span>");d.isChanges=0;d.notify($.t("management:message.Group has been saved"),"success");if(d.targetView){d.targetView.model.add(d.model,{at:0})}},error:function(a,b){debug.error(b.responseText);d.notify($.t("management:message.Group save failed"),"error")}})}else{this.notify($.t("app:message.Invalid data"),"error");AlertErrorFocus(this.form.$el)}},cancel:function(){if(this.model.isNew()){delete this.model;this.newModel();this.render();return this}var a=this;this.model.fetch({success:function(){a.render()}})},notify:function(a,b){var c=$(".notification-area");var d=new AlertMessageView({message:a,type:b});c.append(d.el)}});window.ManagementGroupListView=Backbone.View.extend({firstrun:true,initialize:function(a){this.searchTxt="";$.extend(this,a);this.model=new ManagementGroupCollection;this.initModel();this.initEvents();this.fetch()},initModel:function(){},initEvents:function(){this.model.on("add change sync reset",this.render,this);this.model.on("add change remove",function(){if(ManagementGroupSelectInstance)ManagementGroupSelectInstance.deferredFetch(function(){ManagementGroupSelectInstance.deferredReset()})},this);this.model.on("sync reset",function(){window.spinner.stop()});this.model.on("fetch:started",function(){window.spinner.spin()});this.on("mgdeleted",this.render,this);this.on("search",this.search,this)},events:{active_pane:"render"},fetch:function(){var a=this;this.model.fetch({error:function(b){debug.log("Failed",b);window.spinner.stop();a.render({fail:true})}})},render:function(a){var b=this;$(this.el).html('<div id="toolbar-area" style="padding-bottom: 10px;">      </div><div id="list-area"></div>');var c=$("#toolbar-area",this.$el);c.html(new ManagementGroupSearchToolbarView({targetView:this,targetFormView:this.targetView,searchTxt:this.searchTxt}).el);var d=$("#list-area",this.$el);d.html((new ManagementGroupItemHeaderView).el);var e=$("tbody",d);if(a&&a.fail){e.append('<td colspan="4">'+(new AlertCouldNotGetDataView).$el.html()+"</td>");$(this.el).i18n();return this}var f=this.model.currentPage*this.model.perPage;_.each(this.model.models,function(a){a.attributes.listno=++f;a.attributes.groupstatus_icon=a.attributes.groupstatus?"ok":"lock";var b=new ManagementGroupItemView({model:a});e.append(b.el);b.$el.attr("id",a.attributes._id)});if(this.model.models.length<=0){if(this.model.currentPage!==0){this.model.goTo(this.model.currentPage-1)}else{if(!this.firstrun){e.append('<td colspan="4">'+(new AlertNoDataView).$el.html()+"</td>")}else{this.firstrun=true}}}var g=b.targetView.model.get("_id");if(g){var h=$("tr[id="+g+"]",this.$el);h.children().css("background","#ccccff");h.css("color","#3366cc")}$("tr",this.$el).click($.proxy(function(a){for(var b=0;b<this.model.models.length;b++){if(this.model.models[b].attributes._id==a.delegateTarget.id){this.targetView.trigger("mgselected",this.model.models[b]);this.render();break}}},this));$("tr",this.$el).each(function(a){$(".item-edit",$(this)).click($.proxy(function(a){for(var c=0;c<b.model.models.length;c++){if(b.model.models[c].attributes._id==this.id){b.targetView.trigger("mgmodify",b.model.models[c]);break}}},this))});var i=new ManagementGroupListPaginator({model:this.model});$(this.el).append(i.el);$(this.el).i18n();return this},search:function(a){this.searchTxt=a;if(!a){this.model.filter=undefined;this.fetch()}else{this.model.filter=this.getFilter(a);this.fetch()}debug.log(this.model.filter)},getFilter:function(a){var b={};if(a!==undefined){var c=a.split(" ");for(var d=0;d<c.length;d++){b.groupname=c[d];b.description=c[d]}}return JSON.stringify(b)}});window.ManagementGroupSearchToolbarView=SearchToolbarView.extend({initialize:function(a){$.extend(this,a);this.defaultSettings({idPrefix:"mg",searchable:true,btnNew:true,btnDelete:true});this.render()}});window.ManagementGroupToolbarView=MainToolbarView.extend({initialize:function(a){$.extend(this,a);this.defaultSettings({idPrefix:"mg",btnSave:true,btnCancel:true});this.render()}});window.ManagementGroupItemView=Backbone.View.extend({tagName:"tr",className:"mg-item",initialize:function(){this.model.bind("change",this.render,this);this.model.bind("destroy",this.close,this);this.render()},render:function(){$(this.el).html(this.template(this.model.toJSON()));return this}});window.ManagementGroupListPaginator=Paginator.extend({pageName:"mglist",initialize:function(a){Paginator.prototype.initialize.call(this)},onClick:function(a){var b=$(a.target,a.delegateTarget).text();var c=parseInt(b);var d=1;this.model.goTo(c-d);Paginator.prototype.onClick(a)}});window.ManagementGroupItemHeaderView=Backbone.View.extend({initialize:function(){this.render()},render:function(){$(this.el).html(this.template(this));return this}});PackageUtils=function(){};window.PackageTemplateView=Backbone.View.extend({initialize:function(){this.PackageUtils=new PackageUtils},events:{"click a#goback-btn":"gobackPane"},render:function(){$(this.el).html("");$(this.el).append(this.template());$(this.el).i18n();return this},gobackPane:function(){$(".tab-pane",this.$el).removeClass("in active");var a=$(".tab-pane:first",this.$el);a.addClass("in active").children().trigger("active_pane")}});window.PackageFormView=Backbone.View.extend({initialize:function(a){$.extend(this,a);this.PackageUtils=new PackageUtils;if(!this.model)this.newModel();this.initEvents();this.initModel()},initEvents:function(){this.on("pkgselected",function(a){if(this.isChanges){this.cancel()}this.model=a;this.initModel.call(this);this.isChanges=0;this.render()},this);this.on("pkgmodify",function(a){this.model=a;this.initModel.call(this);this.isChanges=0;this.render();this.activateFormPane.call(this)},this);this.on("pkgnew",function(){this.newModel();this.render();this.activateFormPane.call(this)},this);this.on("pkgdelete",function(){var a=this;this.model.destroy({wait:true,success:function(b,c){debug.info("Success: Deleted");a.targetView.trigger("pkgdeleted");a.notify($.t("package:message.Policy/Group has been deleted"),"success")},error:function(b,c){debug.error("Failed Delete: ",c.responseText);a.notify($.t("package:message.Could not delete")+": "+c.responseText,"error")}})},this);this.on("save",this.saveChanges,this);this.on("cancel",this.cancel,this)},activateFormPane:function(){var a=this.$el.parentsUntil(".tab-content-root");var b=this.$el.parentsUntil(".tab-content");$(".tab-pane",a).removeClass("in active");$(b).addClass("in active")},initModel:function(){var a=this;this.model.pkgtype=this.pkgtype;this.model.on("change",function(){a.isChanges=1});$.each(this.model.schema,function(b,c){var d=new RegExp(".*Set$");if(d.test(c.type)){var e=a.pkgtype=="inheritance"?true:false;c.nolockbtn=e}})},setTargetView:function(a){this.targetView=a},createForm:function(){if(!this.model.isNew()){var a=$('input[name="name"]',this.form.$el);a.parent().html('        <span class="uneditable-input">'+a.val()+"</span>")}this.form.$el.i18n()},render:function(){if(this.model.isNew()){this.model.set("pkgtype",this.pkgtype)}$(this.el).html(new PackageToolbarView({targetView:this}).el);this.createForm();$(this.el).append('<div class="form-area"></div>');var a=$(".form-area",this.$el);a.html(this.form.el);$(this.el).i18n();return this},events:{"keypress [id$=name]":"pkgnameCheck"},pkgnameCheck:function(a){if(a.charCode===0)return;var b=/[ a-zA-Z0-9_-]/;var c=String.fromCharCode(a.charCode);if(!b.test(c))a.preventDefault()},newModel:function(){if(this.model)delete this.model;this.model=new Package;this.initModel();this.isChanges=0;if(this.targetView)this.targetView.render()},saveChanges:function(){var a=this.form;var b=this.model;var c={};err=this.form.commit({validate:true});debug.log("Error: ",err);if(!err){debug.info("New: %i",this.model.isNew());if(!this.model.isNew()){if(!this.isChanges){this.notify($.t("app:message.Nothing changes"),"warning");return this}}var d=this;this.model.save(c,{wait:true,success:function(b,c){debug.info("Success: Saved");var e=$('input[name="name"]',a.$el);e.parent().html('            <span class="uneditable-input">'+e.val()+"</span>");d.isChanges=0;d.notify($.t("package:message.Policy/Group has been saved"),"success");if(d.targetView){d.targetView.model.add(d.model,{at:0})}},error:function(a,b){debug.error(b.responseText);d.notify($.t("package:message.Policy/Group save failed"),"error")}})}else{this.notify($.t("app:message.Invalid data"),"error");AlertErrorFocus(this.form.$el)}},cancel:function(){if(this.model.isNew()){delete this.model;this.newModel();this.render();return this}var a=this;this.model.fetch({success:function(){a.render()}})},notify:function(a,b){var c=$(".notification-area");var d=new AlertMessageView({message:a,type:b});c.append(d.el)}});window.PackageTemplateFormView=PackageFormView.extend({initialize:function(a){PackageFormView.prototype.initialize.call(this,a)},createForm:function(){var a=_.omit(this.model.schema,"inherited");this.model.schema=a;this.form=new Backbone.Form({model:this.model,fieldsets:[{legend:$.t("package:form.Profile"),fields:["name","description","management_group","pkgtype"]},{legend:$.t("package:form.Service"),fields:["class_of_service"]},{legend:$.t("package:form.Session Control"),fields:["simulteneous_use","session_timeout","max_all_session","max_daily_session","max_monthly_session"]},{legend:$.t("package:form.Bandwidth Control"),fields:["bandwidth_max_down","bandwidth_max_up"]},{legend:$.t("package:form.Access Control"),fields:["max_access_period"]}]});this.form.render();PackageFormView.prototype.createForm.call(this)}});window.PackageInheritanceFormView=PackageFormView.extend({initialize:function(a){PackageFormView.prototype.initialize.call(this,a);this.templateModel=new Package;this.templateModel.pkgtype="template"},events:{'change select[name="inherited"]':function(){this.isChanges=1;this.updateTemplateMask()}},createForm:function(){var a=_.omit(this.model.schema,"management_group");this.model.schema=a;this.form=new Backbone.Form({model:this.model,fieldsets:[{legend:$.t("package:form.Profile"),fields:["inherited","name","description","packagestatus","pkgtype"]},{legend:$.t("package:form.Service"),fields:["class_of_service"]},{legend:$.t("package:form.Session Control"),fields:["simulteneous_use","session_timeout","max_all_session","max_daily_session","max_monthly_session"]},{legend:$.t("package:form.Bandwidth Control"),fields:["bandwidth_max_down","bandwidth_max_up"]},{legend:$.t("package:form.Access Control"),
fields:["max_access_period","expiration"]}]});console.log("Created form:",this.form);this.form.render();var b=$('[name="expiration"]',this.form.$el);b.css("border","0px");$("input",this.form.$el).iCheck(window.icheck_settings);PackageFormView.prototype.createForm.call(this)},render:function(){PackageFormView.prototype.render.call(this);this.updateTemplateMask();return this},updateTemplateMask:function(){var a=$('select[name="inherited"]',this.form.$el);var b=this;if(a.val()===null){PackageSelectInstance.fetch({success:function(a,c){if(a.models.length>0)b.setMaskToTemplate.call(b)}});return}this.setMaskToTemplate()},setMaskToTemplate:function(a){var a=$('select[name="inherited"]',this.form.$el);var b=this;if(a.val()===null){return}this.templateModel.set({_id:a.val()},{silent:true});this.templateModel.fetch({success:function(a,c){b.applyMask.call(b,a)}})},applyMask:function(a){var b=this;$.each(this.model.attributes,function(a,c){var d=new String(c);var e=d.split("*");if(e[1]!==undefined){b.model.set(a,e[0])}});$.each(a.attributes,function(a,c){var d=new String(c);var e=d.split("*");if(e[1]!==undefined){b.model.set(a,c)}});this.model.set("inherited",a.get("_id"),{silent:true});this.createForm();var c=$(".form-area",this.$el);c.html(this.form.el)},fetchSelect:function(){}});window.PackageSearchToolbarView=SearchToolbarView.extend({initialize:function(a){$.extend(this,a);this.defaultSettings({idPrefix:"pkg",searchable:true,btnNew:true,btnDelete:true});this.render()}});window.PackageToolbarView=MainToolbarView.extend({initialize:function(a){$.extend(this,a);this.defaultSettings({idPrefix:"pkg",btnSave:true,btnCancel:true});this.render()}});window.PackageListView=Backbone.View.extend({firstrun:true,initialize:function(a){this.searchTxt="";$.extend(this,a);this.model=new PackageCollection;this.initModel();this.initEvents();this.fetch()},initModel:function(){this.model.initUrl.call(this.model,this.pkgtype)},initEvents:function(){this.model.on("add change sync reset",this.render,this);this.model.on("add change remove",function(){if(this.pkgtype=="template"&&PackageSelectInstance)PackageSelectInstance.deferredFetch(function(){PackageSelectInstance.deferredReset()});if(this.pkgtype=="inheritance"&&PackageSelectInheritInstance)PackageSelectInheritInstance.deferredFetch(function(){PackageSelectInheritInstance.deferredReset()})},this);this.model.on("sync reset",function(){window.spinner.stop()});this.model.on("fetch:started",function(){window.spinner.spin()});this.on("pkgdeleted",this.render,this);this.on("search",this.search,this)},events:{active_pane:"render"},fetch:function(){var a=this;this.model.fetch({error:function(b){debug.log("Failed",b);window.spinner.stop();a.render({fail:true})}})},render:function(a){var b=this;if(a===undefined||a===false){ManagementGroupSelectInstance.deferredFetch(function(){b.render(true)});return this}$(this.el).html('<div id="toolbar-area" style="padding-bottom: 10px;">      </div><div id="list-area"></div>');var c=$("#toolbar-area",this.$el);c.html(new PackageSearchToolbarView({targetView:this,targetFormView:this.targetView,searchTxt:this.searchTxt}).el);var d=$("#list-area",this.$el);if(this.pkgtype=="template"){d.html((new PackageTemplateItemHeaderView).el)}else{d.html((new PackageItemHeaderView).el)}var e=$("tbody",this.$el);if(a&&a.fail){e.append('<td colspan="4">'+(new AlertCouldNotGetDataView).$el.html()+"</td>");return this}var f=this.model.currentPage*this.model.perPage;_.each(this.model.models,function(a){debug.log("chk",a);a.attributes.listno=++f;if(a.attributes.pkgtype=="template"){a.attributes.management_group_txt=ManagementGroupSelectInstance.getById(a.get("management_group"))}a.attributes.expired_icon="";if(a.attributes.pkgtype=="inheritance"){a.attributes.packagestatus_icon=a.attributes.packagestatus?"ok":"lock";var c=a.attributes.expiration;if(c!==undefined){if(c.enabled===true){var d=new Date;var g=new Date(c.timestamp);if(d>g){a.attributes.expired_icon="time"}}}}else{a.attributes.packagestatus_icon="ok"}var h;if(b.pkgtype=="template"){h=new PackageTemplateItemView({model:a})}else{h=new PackageItemView({model:a})}e.append(h.el);h.$el.attr("id",a.attributes._id)});if(this.model.models.length<=0){if(this.model.currentPage!==0){this.model.goTo(this.model.currentPage-1)}else{if(!this.firstrun){e.append('<td colspan="4">'+(new AlertNoDataView).$el.html()+"</td>")}else{this.firstrun=false}}}var g=b.targetView.model.get("_id");if(g){var h=$("tr[id="+g+"]",this.$el);h.children().css("background","#ccccff");h.css("color","#3366cc")}$("tr",this.$el).click($.proxy(function(a){for(var b=0;b<this.model.models.length;b++){if(this.model.models[b].attributes._id==a.delegateTarget.id){this.targetView.trigger("pkgselected",this.model.models[b]);this.render();break}}},this));$("tr",this.$el).each(function(a){$(".item-edit",$(this)).click($.proxy(function(a){for(var c=0;c<b.model.models.length;c++){if(b.model.models[c].attributes._id==this.id){b.targetView.trigger("pkgmodify",b.model.models[c]);break}}},this))});var i=new PackageListPaginator({model:this.model});$(this.el).append(i.el);$(this.el).i18n();return this},search:function(a){this.searchTxt=a;if(!a){this.model.filter=undefined;this.fetch()}else{this.model.filter=this.getFilter(a);this.fetch()}debug.log(this.model.filter)},getFilter:function(a){var b={};if(a!==undefined){var c=a.split(" ");for(var d=0;d<c.length;d++){b.name=c[d];b.description=c[d]}}return JSON.stringify(b)}});window.PackageListPaginator=Paginator.extend({pageName:"pkglist",initialize:function(a){Paginator.prototype.initialize.call(this)},onClick:function(a){var b=$(a.target,a.delegateTarget).text();var c=parseInt(b);var d=1;this.model.goTo(c-d);Paginator.prototype.onClick(a)}});window.PackageItemView=Backbone.View.extend({tagName:"tr",className:"pkg-item",initialize:function(){this.model.bind("change",this.render,this);this.model.bind("destroy",this.close,this);this.render()},render:function(){$(this.el).html(this.template(this.model.toJSON()));return this}});window.PackageTemplateItemView=Backbone.View.extend({tagName:"tr",className:"pkg-item",initialize:function(){this.model.bind("change",this.render,this);this.model.bind("destroy",this.close,this);this.render()},render:function(){$(this.el).html(this.template(this.model.toJSON()));return this}});window.PackageTemplateItemHeaderView=Backbone.View.extend({initialize:function(){this.render()},render:function(){$(this.el).html(this.template(this));return this}});window.PackageItemHeaderView=Backbone.View.extend({initialize:function(){this.render()},render:function(){$(this.el).html(this.template(this));return this}});UserUtils=function(){};window.UserView=Backbone.View.extend({initialize:function(){this.UserUtils=new UserUtils},events:{"click a#goback-btn":"gobackPane"},render:function(){$(this.el).html("");$(this.el).append(this.template());this.$el.i18n();return this},gobackPane:function(){$(".tab-pane",this.$el).removeClass("in active");var a=$(".tab-pane:first",this.$el);a.addClass("in active").children().trigger("active_pane")}});window.UserImportListItemView=Backbone.View.extend({importing:false,initialize:function(){this.on("remove_confirm",this.onRemoveConfirm,this);this.render()},render:function(a){if(a===undefined)a=false;$(this.el).html("");$(this.el).append(this.template(this.model.toJSON()));$(".import-list").removeClass("active");if(a)$(".import-list",$(this.el)).addClass("active");if(this.model.attributes.status&&!this.model.attributes.status.imported&&this.model.attributes.status.importing){this.importProgress()}$(this.el).i18n();return this},events:{click:"loadData",mouseenter:"showButtons",mouseleave:"hideButtons","click [class$=import-remove]":"removeImportInvoke","click [id$=import-start]":"startImport"},loadData:function(a,b){var c=this;if(this.importing&&a!="force")return;if($(".import-list",$(this.el)).hasClass("active")&&this.model.attributes.status.processed&&a!="force"){return}$("#ImportContent").html("");var d=new UserImportListCollection;var e=new UserImportListCollection;d.setImportID(this.model.attributes.importid);e.setImportID(this.model.attributes.importid);e.getFailItems(true);function f(a,b){var c={};var d={};if(b=="success"){c=UserImportItemHeaderView;d=UserImportItemView}else if(b=="fail"){c=UserImportItemHeaderView;d=UserImportItemView}header=(new c).render();importContent=$("#ImportContent");importContent.html("<div class='in fade' id='loader'></div>");importContent.append(header.el);importContent.i18n();table_body=$("tbody",importContent);container=$("#user-list");iteration=0;$("#loader",importContent).css("width",container.width()).css("position","absolute").css("top",container.offset().top).css("height",container.height()).css("z-index",900);function e(){for(var b=0;b<a.models.length;b++){var c=a.models[b];if(!a.models[b].attributes.hasOwnProperty("fail"))a.models[b].attributes.fail=undefined;var e=new d({model:c});table_body.append(e.el)}}var f=$(document);e();f.scrollTop(0);iteration++;toggle=false;stop=false;size=a.models.length;function g(){a.setStartIdx(iteration*size+1);function b(){$("#loader").hide();toggle=false}a.fetch({success:function(){b();if(a.length===0){stop=true;return}e();iteration++},error:function(){b()}})}var h=$("#ImportListContent");f.scroll(function(){if(stop)return;threshold=table_body.prop("scrollHeight")-h.height()-table_body.offset().top-200;if(f.scrollTop()>threshold){if(!toggle){$("#loader").css("height",f.height()+50).show();toggle=true;g()}}else{toggle=false}})}if(this.model.attributes.status&&this.model.attributes.status.imported){c.render(true);d.fetch({success:function(){f(d,"success")}})}else if(this.model.attributes.status&&this.model.attributes.status.importing){c.render(true);d.fetch({success:function(){f(d,"success")}})}else{e.fetch({success:function(){var a=e.importCount;var g=e.importFail;c.model.set({status:{processed:true,count:a,fail:g}});c.model.save({},{wait:true,success:function(a,d){if(b!==undefined)b(g);else c.render(true)},error:function(){}});if(g===0){d.fetch({success:function(){f(d,"success")}})}else{f(e,"fail")}}})}},showButtons:function(){if(this.importing)return;$(".import-list-command",$(this.el)).removeClass("hide")},hideButtons:function(){$(".import-list-command",$(this.el)).addClass("hide")},removeImportInvoke:function(a){a.stopPropagation();if(this.model.attributes.status.imported){this.remove_confirm_modal=new ConfirmModalView({modal_id:"remove"+this.model.attributes.importid,confirm_trigger:"remove_confirm",targetView:this,modal_body:'<p><span data-i18n="app:message.Remove the import data will reverts all related imported users">Remove the import data will reverts all related imported users</span></p><p><span data-i18n="app:message.please confirm your intention">please confirm your intention.</span></p>'});$("#modal-area-confirmation").html(this.remove_confirm_modal.el);$(this.remove_confirm_modal.el).i18n();this.remove_confirm_modal.show()}else{this.removeImport()}},onRemoveConfirm:function(){this.removeImport()},removeImport:function(){var a=this;this.model.destroy({wait:true,success:function(){$("#ImportContent").html("");$(a.el).hide()},error:function(b,c){a.notify($.t("app:message.Nothing deleted"),"error")}})},setImporting:function(a){this.importing=a},importProgress:function(){if(!this.progress){this.progress=new UserImportProgress;this.progress.id=this.model.attributes.importid;this.progress_timeout=600}var a=this.progress;var b=this.progress_timeout;a.fetch({success:$.proxy(function(){var c=$(".progress .progress-bar");var d=$("#percent-progress",$(this.el));var e=a.attributes.progress;debug.log("Progress:",e+"%");c.css("width",e+"%").addClass("progress-bar-success");d.html(e+"%");if(e<100&&--b>0){setTimeout($.proxy(function(){this.importProgress()},this),1e3)}else{var f=this.model.get("status");f.imported=true;this.model.set({status:f});this.model.save({},{wait:true,success:$.proxy(function(){this.render(true)},this)});this.setImporting(false);setTimeout(function(){c.css("width",0).removeClass("progress-bar-success")},2e3)}},this)})},startImport:function(a){var b=this;this.setImporting(true);this.hideButtons();$("#import-start",this.$el).hide();a.stopPropagation();this.loadData("force",$.proxy(function(a){if(a>0)return;var b=new UserImportStart;b.id=this.model.attributes.importid;this.importProgress();b.save({},{success:function(){}})},this))},notify:function(a,b){var c=$(".notification-area");var d=new AlertMessageView({message:a,type:b});c.append(d.el)}});window.UserImportListView=Backbone.View.extend({setTarget:function(a){this.target=a},render:function(){var a=this.target;$(this.el).html("");a.html("");var b=new UserImportMetaCollection;b.fetch({success:function(){var c=0;_.each(b.models,function(b){var d=c%4;var e=Math.floor(c/4);if(d===0){addRow="<div class='row' id='row"+e+"'></div>";a.append(addRow)}rowContainer=$("#row"+e,a);b.attributes.id=b.attributes.importid.substr(0,16);locale=$.i18n.lng();topts={day:"numeric",month:"long",year:"numeric",hour:"numeric",minute:"numeric"};b.attributes.timestamp=new Intl.DateTimeFormat(locale,topts).format(new Date(b.attributes.timestamp));var f=new UserImportListItemView({model:b});rowContainer.append(f.el);c++})}});return this}});window.UserImportItemHeaderView=Backbone.View.extend({render:function(){$(this.el).html("");$(this.el).append(this.template());return this}});window.UserImportItemView=Backbone.View.extend({tagName:"tr",className:"import-item",initialize:function(){this.render()},render:function(){$(this.el).html(this.template(this.model.toJSON()));var a=40;$(this.el).each(function(){$(".autotrim",this).each(function(){if($(this).html().length>a)$(this).html($(this).html().substr(0,a)+" ..")})});return this}});window.UserImportView=UserView.extend({render:function(){var a=this;var b=$(this.el);b.html("");b.append(this.template());var c=$(".progress .progress-bar",$(this.el));function d(a){setTimeout(function(){c.css("width",0);setTimeout(function(){c.removeClass("progress-bar-"+a)},2e3)},3e3)}function e(a){t=a.substr(a.length-4,a.length).toLowerCase();t=t.replace(".","");if(t=="csv")return true;else return false}$("#fileupload",b).fileupload({dataType:"json"}).on("fileuploadprogressall",function(a,b){var d=parseInt(b.loaded/b.total*100,10);c.addClass("progress-bar-success").css("width",d+"%")}).on("fileuploaddone",function(b,e){if(e.result.success){a.ImportListView.render();a.notify($.t("user:message.Upload success"),"success");d("success")}else{c.addClass("progress-bar-danger");a.notify($.t("user:message.Upload fail_invalid data"),"error");d("danger")}}).on("fileuploadfail",function(b,e){c.addClass("progress-bar-danger");a.notify($.t("user:message.Upload fail"),"error");d("danger")}).on("fileuploadadd",function(b,f){var g=f.files[0].name;if(!e(g)){c.addClass("progress-bar-danger").css("width","100%");d("danger");a.notify($.t("user:message.Invalid file extension_csv"),"error");return false}f.submit()});var f=new UserImportListView;f.setTarget($("#ImportListContent",$(this.el)));f.render();this.ImportListView=f;this.$el.i18n();return this},events:{"hidden.bs.collapse [id$=ImportList]":"updateTable"},updateTable:function(){},notify:function(a,b){var c=$(".notification-area");var d=new AlertMessageView({message:a,type:b});c.append(d.el)}});window.UserFormView=Backbone.View.extend({initialize:function(a){$.extend(this,a);this.UserUtils=new UserUtils;if(!this.model)this.newModel();this.initEvents();this.initModel()},initEvents:function(){this.on("userselected",function(a){this.model=a;this.initModel.call(this);this.isChanges=0;this.render()},this);this.on("usermodify",function(a){this.model=a;this.initModel.call(this);this.isChanges=0;this.render();this.activateFormPane.call(this)},this);this.on("usernew",function(){this.newModel();this.render();this.activateFormPane.call(this)},this);this.on("userdelete",function(){var a=this;this.model.destroy({wait:true,success:function(b,c){debug.info("Success: Deleted");a.targetView.trigger("userdeleted");a.notify($.t("user:message.User has been deleted"),"success")},error:function(b,c){debug.error("Failed Delete: ",c.responseText);a.notify($.t("user:message.Could not delete user")+": "+c.responseText,"error")}})},this);this.on("save",this.saveChanges,this);this.on("cancel",this.cancel,this)},activateFormPane:function(){var a=this.$el.parentsUntil(".tab-content-root");var b=this.$el.parentsUntil(".tab-content");$(".tab-pane",a).removeClass("in active");$(b).addClass("in active")},initModel:function(){var a=this;this.model.on("change",function(){a.isChanges=1})},setTargetView:function(a){this.targetView=a},createForm:function(){var a=[{legend:$.t("user:form.Profile"),fields:["username","package","description","userstatus"]},{legend:$.t("user:form.Contact"),fields:["firstname","surname","personid","email"]},{legend:$.t("user:form.Authentication"),fields:["password","password_confirm"]},{legend:$.t("user:form.Authentication (Optional)"),fields:["macs_binding"]},{legend:$.t("user:form.Period Control"),fields:["expiration"]}];if(permission.isRole("Admin")){a.push({legend:$.t("user:form.Management"),fields:["management","roles"]})}this.form=new Backbone.Form({model:this.model,fieldsets:a});debug.log(this.form);this.form.render();var b=$('[name="expiration"]',this.form.$el);b.css("border","0px");$("input",this.form.$el).iCheck(window.icheck_settings);if(!this.model.isNew()){var c=$('input[name="username"]',this.form.$el);c.parent().html('        <span class="uneditable-input">'+c.val()+"</span>")}},render:function(){$(this.el).html(new UserToolbarView({targetView:this}).el);this.createForm();$(this.el).append('<div class="form-area"></div>');var a=$(".form-area",this.$el);a.html(this.form.el);$(this.el).i18n();$("form",this.$el).on("click",this.updateModalI18n);return this},events:{"keypress [id$=username]":"usernameCheck"},updateModalI18n:function(a){if(!$(a.target).hasClass("bbf-add")&&!$(a.target).hasClass("bbf-list-modal")){return}var b=[200,500,1e3];for(var c=0;c<b.length;c++){setTimeout(function(){$(".modal",$("body")).i18n();$(".modal #mac",$("body")).attr("placeholder","aa:bb:cc:dd:ee:ff").focus()},b[c])}},newModel:function(){if(this.model)delete this.model;this.model=new User;this.initModel();this.isChanges=0;if(this.targetView)this.targetView.render()},saveChanges:function(){var a=this.form;var b=this.model;var c={};err=this.form.commit({validate:true});if(!err){debug.info("New: %i",this.model.isNew());this.model.bypassUserCheck=true;if(!this.model.isNew()){if(!this.isChanges){this.notify($.t("app:message.Nothing changes"),"warning");return this}}var d=this;this.model.save(c,{wait:true,success:function(b,c){debug.info("Success: Saved");var e=$('input[name="username"]',a.$el);e.parent().html('            <span class="uneditable-input">'+e.val()+"</span>");d.isChanges=0;d.notify($.t("user:message.User has been saved"),"success");d.model.bypassUserCheck=false;if(d.targetView){d.targetView.model.add(d.model,{at:0})}},error:function(a,b){debug.error(b.responseText);d.notify($.t("user:message.User save failed")+": "+b.responseText,"error");d.model.bypassUserCheck=false}})}else{this.notify($.t("app:message.Invalid data"),"error");AlertErrorFocus(this.form.$el)}},cancel:function(){if(this.model.isNew()){delete this.model;this.newModel();this.render();return this}var a=this;this.model.fetch({success:function(){a.render()}})},notify:function(a,b){var c=$(".notification-area");var d=new AlertMessageView({message:a,type:b});c.append(d.el)},usernameCheck:function(a){if(a.charCode===0)return;var b=/[A-Z]/;var c=/[a-z0-9\\._-]/;var d=String.fromCharCode(a.charCode);if(b.test(d)){var e=$("input",this.$el)[0];$(e).val(function(a,b){return(b+d).toLowerCase()})}if(!c.test(d))a.preventDefault()}});window.UserSelfServiceFormView=Backbone.View.extend({initialize:function(a){$.extend(this,a);this.UserUtils=new UserUtils;this.initEvents()},initEvents:function(){this.on("userselected",function(a){this.model=a;this.initModel.call(this);this.isChanges=0;this.render()},this);this.on("save",this.saveChanges,this);this.on("cancel",this.cancel,this)},initModel:function(){var a=this;this.model.on("change",function(){a.isChanges=0;$.each(this.changed,function(b,c){switch(b){case"package":case"password":case"password_confirm":if(c==="")return;break;case"userstatus":return}a.isChanges=1})})},createForm:function(){var a=[{legend:$.t("user:form.Profile"),fields:["username"]},{legend:$.t("user:form.Contact"),fields:["firstname","surname","personid","email"]},{legend:$.t("user:form.Authentication"),fields:["password","password_confirm"]},{legend:$.t("user:form.Authentication (Optional)"),fields:["macs_binding"]}];this.form=new Backbone.Form({model:this.model,fieldsets:a});this.form.render();this.form.$el.i18n();$("input",this.form.$el).iCheck(window.icheck_settings);var b=["username","firstname","surname","email"];for(var c=0;c<b.length;c++){var d=b[c];var e=$('input[name="'+d+'"]',this.form.$el);e.parent().html("<span class='form-control uneditable-input'>"+e.val()+"</span>")}var f=$('div[name="personid"]',this.form.$el);var g=$("input",f).val();var h=$("select option:selected",f).text();f.html("<span class='form-control uneditable-input'>"+h+" - "+g+"</span>");f.html();$(".uneditable-input",this.form.$el).css("border","0px")},render:function(){$(this.el).html(new UserToolbarView({targetView:this}).el);this.createForm();$(this.el).append('<div class="form-area"></div>');var a=$(".form-area",this.$el);a.html(this.form.el);$(this.el).i18n();$("form",this.$el).on("click",this.updateModalI18n);return this},updateModalI18n:function(a){if(!$(a.target).hasClass("bbf-add")&&!$(a.target).hasClass("bbf-list-modal")){return}var b=[200,500,1e3];for(var c=0;c<b.length;c++){setTimeout(function(){$(".modal",$("body")).i18n();$(".modal #mac",$("body")).attr("placeholder","aa:bb:cc:dd:ee:ff").focus()},b[c])}},saveChanges:function(){var a=this.form;var b=this.model;var c={};err=this.form.commit({validate:true});if(!err){debug.info("New: %i",this.model.isNew());this.model.bypassUserCheck=true;if(!this.isChanges){this.notify($.t("app:message.Nothing changes"),"warning");return this}var d=this;this.model.save(c,{wait:true,success:function(a,b){debug.info("Success: Saved");d.isChanges=0;d.notify($.t("user:message.User has been saved"),"success");d.model.bypassUserCheck=false},error:function(a,b){debug.error(b.responseText);d.notify($.t("user:message.User save failed")+": "+b.responseText,"error");d.model.bypassUserCheck=false}})}else{this.notify($.t("app:message.Invalid data"),"error");AlertErrorFocus(this.form.$el)}},cancel:function(){var a=this;this.model.fetch({success:function(){a.render()}})},notify:function(a,b){var c=$(".notification-area");var d=new AlertMessageView({message:a,type:b});c.append(d.el)}});window.UserListView=Backbone.View.extend({firstrun:true,initialize:function(a){this.searchTxt="";$.extend(this,a);this.model=new UserCollection;this.initModel();this.initEvents();this.fetch()},initModel:function(){},initEvents:function(){var a=this;this.model.on("add change sync reset",this.render,this);this.model.on("add change remove",function(){if(UserSelectInstance)UserSelectInstance.deferredFetch(function(){UserSelectInstance.deferredReset()})});this.model.on("sync reset",function(){window.spinner.stop()});this.model.on("fetch:started",function(){window.spinner.spin()});this.on("userdeleted",this.render,this);this.on("search",this.search,this)},events:{active_pane:"render"},fetch:function(){var a=this;this.model.fetch({error:function(b){debug.log("Failed",b);window.spinner.stop();a.render({fail:true})}})},render:function(a){var b=this;$(this.el).html('<div id="toolbar-area" style="padding-bottom: 10px;">      </div><div id="list-area"></div>');var c=$("#toolbar-area",this.$el);c.html(new UserSearchToolbarView({targetView:this,targetFormView:this.targetView,searchTxt:this.searchTxt}).el);var d=$("#list-area",this.$el);d.html((new UserItemHeaderView).el);var e=$("tbody",d);if(a&&a.fail){e.append('<td colspan="5">'+(new AlertCouldNotGetDataView).$el.html()+"</td>");$(this.el).i18n();return this}var f=this.model.currentPage*this.model.perPage;_.each(this.model.models,function(a){a.attributes.listno=++f;a.attributes.userstatus_icon=a.attributes.userstatus?"ok":"lock";a.attributes.registered_icon=a.attributes.usertype=="register"?"barcode":"";a.attributes.import_icon=a.attributes.usertype=="import"?"import":"";a.attributes.expired_icon="";var b=a.attributes.expiration;if(b!==undefined){if(b.enabled===true){var c=new Date;var d=new Date(b.timestamp);if(c>d){a.attributes.expired_icon="time"}}}a.attributes.usermanagement_icon=a.attributes.management?"star":"";if(a.attributes.roles!==undefined&&a.attributes.roles.length>0){a.attributes.useradmin_icon="";for(var g=0;g<a.attributes.roles.length;g++){if(a.attributes.roles[g].name=="Admin"){a.attributes.useradmin_icon="flag"}}}else{a.attributes.useradmin_icon=""}var h=new UserItemView({model:a});e.append(h.el);h.$el.attr("id",a.attributes._id)});$('input[type="checkbox"]',e).attr("checked",function(a,c){var d=$(this).parent().parent().attr("id");var e=b.model.get(d);return e.check?true:false});$('input[type="checkbox"]',e).click(function(a){var c=$(this).parent().parent().attr("id");if(c){var d=b.model.get(c);var e=$(this).is(":checked");d.check=e}});if(this.model.models.length<=0){if(this.model.currentPage!==0){this.model.goTo(this.model.currentPage-1)}else{if(!this.firstrun){e.append('<td colspan="5">'+(new AlertNoDataView).$el.html()+"</td>")}else{this.firstrun=false}}}var g=b.targetView.model.get("_id");if(g){var h=$("tr[id="+g+"]",this.$el);h.children().css("background","#ccccff");h.css("color","#3366cc")}$("tr",this.$el).click($.proxy(function(a){for(var b=0;b<this.model.models.length;b++){if(this.model.models[b].attributes._id==a.delegateTarget.id){this.targetView.trigger("userselected",this.model.models[b]);this.render();break}}},this));$("tr",this.$el).each(function(a){$(".item-edit",$(this)).click($.proxy(function(a){for(var c=0;c<b.model.models.length;c++){if(b.model.models[c].attributes._id==this.id){b.targetView.trigger("usermodify",b.model.models[c]);break}}},this))});var i=new UserListPaginator({model:this.model});$(this.el).append(i.el);$(this.el).i18n();return this},search:function(a){this.searchTxt=a;if(!a){this.model.filter=undefined;this.fetch()}else{this.model.filter=this.getFilter(a);this.fetch()}debug.log(this.model.filter)},getFilter:function(a){var b={};if(a!==undefined){var c=a.split(" ");for(var d=0;d<c.length;d++){b.username=c[d];b.firstname=c[d];b.surname=c[d];b.package=c[d]}}debug.log(JSON.stringify(b));return JSON.stringify(b)}});window.UserItemView=Backbone.View.extend({tagName:"tr",className:"user-item",initialize:function(){this.model.bind("change",this.render,this);this.model.bind("destroy",this.close,this);this.render()},render:function(){$(this.el).html(this.template(this.model.toJSON()));var a=15;$(this.el).each(function(){$(".autotrim",this).each(function(){if($(this).html().length>a)$(this).html($(this).html().substr(0,a)+" ..")})});return this}});window.UserListPaginator=Paginator.extend({pageName:"userlist",initialize:function(a){Paginator.prototype.initialize.call(this)},onClick:function(a){var b=$(a.target,a.delegateTarget).text();var c=parseInt(b);var d=1;this.model.goTo(c-d);Paginator.prototype.onClick(a)}});window.UserSearchToolbarView=SearchToolbarView.extend({initialize:function(a){$.extend(this,a);this.defaultSettings({idPrefix:"user",searchable:true,btnNew:true,btnDelete:true});this.render()}});window.UserToolbarView=MainToolbarView.extend({initialize:function(a){$.extend(this,a);this.defaultSettings({idPrefix:"user",btnSave:true,btnCancel:true});this.render()}});window.UserItemHeaderView=Backbone.View.extend({initialize:function(){this.render()},render:function(){$(this.el).html(this.template(this));return this}});AccessCodeUtils=function(){};AccessCodeUtils.prototype.getFormActions=function(a){var b="";b+='<div class="form-actions">';b+='  <button class="btn btn-primary" id="'+a+'save"><i class="icon-ok icon-white"></i> <span data-i18n="app:button.save">Save changes</span></button>';b+='  <button class="btn" id="'+a+'cancel"><i class="icon-remove"></i> <span data-i18n="app:button.cancel">Cancel</span></button>';b+="</div>";return b};window.AccessCodeView=Backbone.View.extend({initialize:function(){this.AccessCodeUtils=new AccessCodeUtils},events:{"click a#goback-btn":"gobackPane"},render:function(){$(this.el).html("");$(this.el).append(this.template());this.$el.i18n();return this},gobackPane:function(){$(".tab-pane",this.$el).removeClass("in active");var a=$(".tab-pane:first",this.$el);a.addClass("in active").children().trigger("active_pane")}});window.AccessCodeFormView=Backbone.View.extend({initialize:function(a){$.extend(this,a);this.AccessCodeUtils=new AccessCodeUtils;if(!this.model)this.newModel();this.initEvents();this.initModel()},initEvents:function(){this.on("acselected",function(a){this.model=a;this.initModel.call(this);this.isChanges=0;this.render()},this);this.on("acmodify",function(a){this.model=a;this.initModel.call(this);this.isChanges=0;this.render();this.activateFormPane.call(this)},this);this.on("acnew",function(){this.newModel();this.render();this.activateFormPane.call(this)},this);this.on("save",this.saveChanges,this);this.on("cancel",this.cancel,this)},activateFormPane:function(){var a=this.$el.parentsUntil(".tab-content-root");var b=this.$el.parentsUntil(".tab-content");$(".tab-pane",a).removeClass("in active");$(b).addClass("in active")},initModel:function(){var a=this;this.model.on("change",function(){a.isChanges=1});if(!permission.isRole("Admin")){this.model.amountMax=36}},setTargetView:function(a){this.targetView=a},createForm:function(){var a=[{legend:$.t("accesscode:form.Profile"),fields:["package","purpose","info","amount","expiration"]}];this.form=new Backbone.Form({model:this.model,fieldsets:a});debug.log(this.form);this.form.render();if(!this.model.isNew()){var b=$('select[name="package"]',this.form.$el);b.addClass("disabled");b.attr("disabled","true");var c=$('textarea[name="purpose"]',this.form.$el);c.addClass("disabled");c.attr("disabled","true");var d=$('input[name="amount"]',this.form.$el);d.parent().html('        <span class="uneditable-input">'+d.val()+"</span>")}var e=$('textarea[name="info"]',this.form.$el);e.css("height",100);decoded_val=$("<div/>").html(this.model.get("info")).text();e.val(decoded_val);$("input",this.form.$el).iCheck(window.icheck_settings);var f=$('[name="expiration"]',this.form.$el);f.css("border","0px")},render:function(){$(this.el).html("");$(this.el).append(new AccessCodeToolbarView({targetView:this}).el);this.createForm();$(this.el).append('<div class="form-area"></div>');var a=$(".form-area",this.$el);a.html(this.form.el);$(this.el).i18n();return this},newModel:function(){if(this.model)delete this.model;this.model=new AccessCodeMeta;this.initModel();this.isChanges=0;if(this.targetView)this.targetView.render()},saveChanges:function(){var a=this.form;var b=this.model;var c={};err=this.form.commit({validate:true});if(!err){debug.info("New: %i",this.model.isNew());if(!this.model.isNew()){if(!this.isChanges){this.notify($.t("app:message.Nothing changes"),"warning");return this}}var d=this;this.model.save(c,{wait:true,success:function(a,b){debug.info("Success: Saved");d.render();d.isChanges=0;d.notify($.t("accesscode:message.Access Code has been saved"),"success");if(d.targetView){d.targetView.model.add(d.model,{at:0})}},error:function(a,b){debug.error(b.responseText);d.notify($.t("accesscode:message.Access Code save failed")+": "+b.responseText,"error")}})}else{this.notify($.t("app:message.Invalid data"),"error");AlertErrorFocus(this.form.$el)}},cancel:function(){if(this.model.isNew()){delete this.model;this.newModel();this.render();return this}var a=this;this.model.fetch({success:function(){a.render()}})},notify:function(a,b){var c=$(".notification-area");var d=new AlertMessageView({
message:a,type:b});c.append(d.el)}});window.AccessCodeListView=Backbone.View.extend({firstrun:true,initialize:function(a){this.searchTxt="";$.extend(this,a);this.model=new AccessCodeMetaCollection;this.initModel();this.initEvents();this.fetch()},initModel:function(){},initEvents:function(){this.model.on("add change sync reset",this.render,this);this.model.on("sync reset",function(){window.spinner.stop()});this.model.on("fetch:started",function(){window.spinner.spin()});this.on("acdeleted",this.render,this);this.on("search",this.search,this)},events:{active_pane:"fetch"},fetch:function(){var a=this;this.model.fetch({error:function(b){debug.log("Failed",b);window.spinner.stop();a.render({fail:true})}})},render:function(a){var b=this;$(this.el).html('<div id="toolbar-area" style="padding-bottom: 10px;">      </div><div id="list-area"></div>');var c=$("#toolbar-area",this.$el);c.html(new AccessCodeSearchToolbarView({targetView:this,targetFormView:this.targetView,searchTxt:this.searchTxt}).render().el);var d=$("#list-area",this.$el);d.html((new AccessCodeItemHeaderView).el);var e=$("tbody",d);if(a&&a.fail){e.append('<td colspan="6">'+(new AlertCouldNotGetDataView).$el.html()+"</td>");$(this.el).i18n();return this}var f=this.model.currentPage*this.model.perPage;_.each(this.model.models,function(a){a.attributes.issued_timestamp=new Date(a.get("issued").timestamp).format("d mmm yyyy HH:MM");a.attributes.expired_icon="";var c=a.attributes.expiration;if(c!==undefined){if(c.enabled===true){var d=new Date;var f=new Date(c.timestamp);if(d>f){a.attributes.expired_icon="time"}}}if(a.attributes.registered===undefined){a.attributes.registered=0}a.attributes.register_all_icon="";if(a.attributes.registered==a.attributes.amount){a.attributes.register_all_icon="check"}var g=new AccessCodeItemView({model:a});e.append(g.el);g.$el.attr("id",a.attributes._id);var h=$("#btnprint"+a.attributes._id,this.$el);h.click(function(a){var b=$(a.target).attr("data-id");if(b===undefined){b=$(a.target).parent().attr("data-id")}window.open("/api/accesscode/pdfcard/"+b,"_blank")});var i=$("#btnedit"+a.attributes._id,this.$el);i.click(function(a){var c=$(a.target).attr("data-id");if(c===undefined){c=$(a.target).parent().attr("data-id")}for(var d=0;d<b.model.models.length;d++){if(b.model.models[d].attributes._id==c){b.targetView.trigger("acmodify",b.model.models[d]);break}}})});if(this.model.models.length<=0){if(this.model.currentPage!==0){this.model.goTo(this.model.currentPage-1)}else{if(!this.firstrun){e.append('<td colspan="7">'+(new AlertNoDataView).$el.html()+"</td>")}else{this.firstrun=false}}}var g=b.targetView.model.get("_id");if(g){var h=$("tr[id="+g+"]",this.$el);h.children().css("background","#ccccff");h.css("color","#3366cc")}$("tr",this.$el).click($.proxy(function(a){for(var b=0;b<this.model.models.length;b++){if(this.model.models[b].attributes._id==a.delegateTarget.id){this.targetView.trigger("acselected",this.model.models[b]);this.render();break}}},this));var i=new AccessCodeListPaginator({model:this.model});$(this.el).append(i.el);$(this.el).i18n();return this},search:function(a){this.searchTxt=a;if(!a){this.model.filter=undefined;this.fetch()}else{this.model.filter=this.getFilter(a);this.fetch()}debug.log(this.model.filter)},getFilter:function(a){var b={};if(a!==undefined){var c=a.split(" ");for(var d=0;d<c.length;d++){b.id=c[d];b.package=c[d];b.purpose=c[d];b.amount=c[d]}}debug.log(JSON.stringify(b));return JSON.stringify(b)}});window.AccessCodeSearchToolbarView=SearchToolbarView.extend({initialize:function(a){$.extend(this,a);this.defaultSettings({idPrefix:"ac",searchable:true,btnNew:true});this.render()}});window.AccessCodeToolbarView=MainToolbarView.extend({initialize:function(a){$.extend(this,a);this.defaultSettings({idPrefix:"ac",btnSave:true,btnCancel:true});this.render()}});window.AccessCodeItemView=Backbone.View.extend({tagName:"tr",className:"ac-item",initialize:function(){this.model.bind("change",this.render,this);this.model.bind("destroy",this.close,this);this.render()},render:function(){$(this.el).html(this.template(this.model.toJSON()));var a=15;$(this.el).each(function(){$(".autotrim",this).each(function(){if($(this).html().length>a)$(this).html($(this).html().substr(0,a)+" ..")})});return this}});window.AccessCodeListPaginator=Paginator.extend({pageName:"aclist",initialize:function(a){Paginator.prototype.initialize.call(this)},onClick:function(a){var b=$(a.target,a.delegateTarget).text();var c=parseInt(b);var d=1;this.model.goTo(c-d);Paginator.prototype.onClick(a)}});window.AccessCodeItemHeaderView=Backbone.View.extend({initialize:function(){this.render()},render:function(){$(this.el).html(this.template(this));return this}});RegisterTrackingUtils=function(){};window.RegisterTrackingView=Backbone.View.extend({initialize:function(){this.RegisterTrackingUtils=new RegisterTrackingUtils},render:function(){$(this.el).html("");$(this.el).append(this.template());return this}});window.RegisterTrackingListView=Backbone.View.extend({initialize:function(a){this.searchTxt="";$.extend(this,a);this.model=new AccessCodeCollection;this.initModel();this.initEvents();this.fetch()},initModel:function(){},initEvents:function(){this.model.on("add change sync reset",this.render,this);this.model.on("sync reset",function(){window.spinner.stop()});this.model.on("fetch:started",function(){window.spinner.spin()});this.on("search",this.search,this)},fetch:function(){var a=this;this.model.fetch({error:function(b){debug.log("Failed",b);window.spinner.stop();a.render({fail:true})}})},render:function(a){var b=this;$(this.el).html('<div id="toolbar-area" style="padding-bottom: 10px;">      </div><div id="list-area"></div>');var c=$("#toolbar-area",this.$el);c.html(new RegisterTrackingSearchToolbarView({targetView:this,searchTxt:this.searchTxt}).render().el);var d=$("#list-area",this.$el);d.html((new RegisterTrackingItemHeaderView).el);var e=$("tbody",d);if(a&&a.fail){e.append('<td colspan="8">'+(new AlertCouldNotGetDataView).$el.html()+"</td>");$(this.el).i18n();return this}var f=this.model.currentPage*this.model.perPage;debug.log(this.model.models);var g="<span class='label label-primary'>T</span>";var h="<span class='label label-primary'>P</span>";_.each(this.model.models,function(a){if(a.attributes.meta!==undefined&&a.attributes.registered.to!==undefined){a.attributes.listno=++f;locale=$.i18n.lng();topts={day:"numeric",month:"long",year:"numeric",hour:"numeric",minute:"numeric"};a.attributes.timestamp=new Intl.DateTimeFormat(locale,topts).format(new Date(a.get("registered").timestamp));a.attributes.serialpadded=(1e15+a.get("serialno")+"").slice(-4);var b=a.attributes.registered.to.personid;var c=b.lastIndexOf(":");var d=b.substr(0,c);var g=b.substr(c+1);var h=d=="Thai Personal ID"?"T":"P";var i=h=="T"?$.t("user:form.Thai Personal ID"):$.t("user:form.Passport No");a.attributes.personid_label_title=i;a.attributes.personid_label=h;a.attributes.personid=g;debug.log(a);var j=new RegisterTrackingItemView({model:a});e.append(j.el);j.$el.attr("id",a.attributes._id)}});if(this.model.models.length<=0||f==this.model.currentPage*this.model.perPage){if(this.model.currentPage!==0){this.model.goTo(this.model.currentPage-1)}else{e.append('<td colspan="8">'+(new AlertNoDataView).$el.html()+"</td>")}}var i=new RegisterTrackingListPaginator({model:this.model});$(this.el).append(i.el);$(this.el).i18n();return this},search:function(a){this.searchTxt=a;if(!a){this.model.filter=undefined;this.fetch()}else{this.model.filter=this.getFilter(a);this.fetch()}debug.log(this.model.filter)},getFilter:function(a){var b=[];if(a!==undefined){var c=a.split(/-/);var d=new Date("Invalid Date");if(c[2]!==undefined){c=a.split(/-| |\//);if(c[1]!==undefined){d=new Date(a)}}if(d.getDate()>=0){var e={};e.timestamp=d;b.push(e)}else{var f=a.split(" ");for(var g=0;g<f.length;g++){if(f[g]==="")continue;var e={};var h=f[g].split(/-|\//);if(h[2]!==undefined){e.timestamp=new Date(h[1]+"/"+h[0]+"/"+h[2])}else if(h[1]!==undefined){e.accesscode=f[g]}else{e.username=f[g];e.firstname=f[g];e.surname=f[g]}b.push(e)}}}debug.log(JSON.stringify(b));return JSON.stringify(b)}});window.RegisterTrackingItemView=Backbone.View.extend({tagName:"tr",className:"ac-item",initialize:function(){this.render()},render:function(){$(this.el).html(this.template(this.model.toJSON()));return this}});window.RegisterTrackingListPaginator=Paginator.extend({pageName:"aclist",initialize:function(a){Paginator.prototype.initialize.call(this)},onClick:function(a){var b=$(a.target,a.delegateTarget).text();var c=parseInt(b);var d=1;this.model.goTo(c-d);Paginator.prototype.onClick(a)}});window.RegisterTrackingSearchToolbarView=SearchToolbarView.extend({initialize:function(a){$.extend(this,a);this.defaultSettings({idPrefix:"user",searchable:true});this.render()}});window.RegisterTrackingItemHeaderView=Backbone.View.extend({initialize:function(){this.render()},render:function(){$(this.el).html(this.template(this));return this}});window.RadiusOnlineUserView=Backbone.View.extend({initialize:function(){},render:function(){$(this.el).html("");$(this.el).append(this.template());return this}});window.RadiusOnlineUserListView=Backbone.View.extend({firstrun:true,initialize:function(a){this.searchTxt="";$.extend(this,a);this.model=new RadiusOnlineUserCollection;this.initModel();this.initEvents();this.fetch();this.setIntervalFetch()},initModel:function(){},initEvents:function(){this.model.on("add change sync reset",this.render,this);this.model.on("sync reset",function(){window.spinner.stop()});this.model.on("fetch:started",function(){window.spinner.spin()});this.on("search",this.search,this);this.on("kick_confirm",this.onKickConfirm,this)},setIntervalFetch:function(){var a=this;if(window.intervalFetch.onlineuser!==undefined){clearInterval(window.intervalFetch.onlineuser)}window.intervalFetch.onlineuser=setInterval(function(){var b=$("#radonlineuser-content");if(b.length>0){a.fetch()}else{a.clearIntervalFetch()}},6e4)},clearIntervalFetch:function(){clearInterval(window.intervalFetch.onlineuser)},fetch:function(){var a=this;this.model.fetch({error:function(b){debug.log("Failed",b);window.spinner.stop();a.render({fail:true})}})},render:function(a){var b=this;$(this.el).html('<div id="toolbar-area" style="padding-bottom: 10px;">      </div><div id="list-area"></div>      <div class="modal" id="kickConfirm"></div>');var c=$("#toolbar-area",this.$el);this.toolbarView=new OnlineUserToolbarView({targetView:this,searchTxt:this.searchTxt});c.html(this.toolbarView.render().el);var d=$("#list-area",this.$el);d.html((new RadiusOnlineUserItemHeaderView).el);var e=$("tbody",d);if(a&&a.fail){e.append('<td colspan="7">'+(new AlertCouldNotGetDataView).$el.html()+"</td>");var f=$("#kickConfirm",this.$el);f.modal({backdrop:"static"});f.modal("hide");this.$el.i18n();return this}var g=this.model.currentPage*this.model.perPage;_.each(this.model.models,function(a){debug.log("data",a);a.attributes.title_description=$.t("onlineusers:title.Description");a.attributes.title_macaddress=$.t("onlineusers:title.MAC Address");a.attributes.title_nasip=$.t("onlineusers:title.NAS IP");a.attributes.title_start=$.t("onlineusers:title.Start");a.attributes.listno=++g;a.attributes.starttime=new Date(a.get("acctstarttime")).format("d mmm yyyy HH:MM");function b(a){var b=new Date(1970,0,1);b.setSeconds(a);var c=b.toTimeString().substr(0,8);if(a>86399)c=Math.floor((b-Date.parse("1/1/70"))/36e5)+c.substr(2);return c}a.attributes.usage=b(((new Date).getTime()-new Date(a.get("acctstarttime")).getTime())/1e3);var c=new RadiusOnlineUserItemView({model:a});e.append(c.el);c.$el.attr("id",a.attributes.radacctid)});$('input[type="checkbox"]',e).attr("checked",function(a,c){var d=$(this).parent().parent().attr("id");var e=b.model.get(d);return e.check?true:false});function h(a){var c=a.parentsUntil("tbody");var d=$(c[c.length-1]);var e=d.attr("id");if(e){var f=b.model.get(e);var g=a;var h=g.is(":checked");f.check=h;if(h){d.attr("data-oldbackground",d.children(":first-child").css("background"));d.attr("data-oldcolor",d.css("color"));d.children().css("background","#ccccff");d.css("color","#3366cc");b.clearIntervalFetch()}else{d.children().css("background",d.attr("data-oldbackground"));d.css("color",d.attr("data-oldcolor"))}}b.toolbarView.updateButton()}var i=$("#user_selectall",this.$el);var j=$('input[type="checkbox"]',e);j.on("ifChecked",function(a){var b=true;j.each(function(a){var c=$(this).is(":checked");if(!c){b=false;return false}});if(b)i.iCheck("check")});j.on("ifUnchecked",function(a){i.partial_checked=true;i.iCheck("uncheck")});j.on("ifChanged",function(a){h($(this))});i.on("ifChanged",function(a){var b=$(this).is(":checked");if(b){j.iCheck("check");i.partial_checked=false}else{if(!i.partial_checked)j.iCheck("uncheck")}});if(this.model.models.length<=0||g==this.model.currentPage*this.model.perPage){if(this.model.currentPage!==0){this.model.goTo(this.model.currentPage-1)}else{if(!this.firstrun){e.append('<td colspan="7">'+(new AlertNoDataView).$el.html()+"</td>")}else{this.firstrun=false}}}var k=new RadiusOnlineUserListPaginator({model:this.model});$(this.el).append(k.el);$(this.el).i18n();$(".rh-popover",this.$el).popover({trigger:"hover",placement:"bottom",html:true});$("input",this.$el).iCheck(window.icheck_settings);return this},search:function(a){this.searchTxt=a;if(!a){this.model.filter=undefined;this.fetch()}else{this.model.filter=this.getFilter(a);this.fetch()}debug.log(this.model.filter)},getFilter:function(a){var b=[];if(a!==undefined){var c=a.split(" ");for(var d=0;d<c.length;d++){if(c[d]==="")continue;b.push(c[d])}}debug.log(JSON.stringify(b));return JSON.stringify(b)},onKickConfirm:function(){var a=this;var b=$("#list-area");var c=$("tbody",b);$('input[type="checkbox"]',c).each(function(b){var c=$(this);var d=c.is(":checked");if(d){var e=c.attr("id");var f=a.model.get(e);if(f){f.destroy({success:function(){a.render()}})}}});$("#kickConfirm").modal("hide")}});window.RadiusOnlineUserItemView=Backbone.View.extend({tagName:"tr",className:"ac-item",initialize:function(){this.render()},render:function(){$(this.el).html(this.template(this.model.toJSON()));return this}});window.RadiusOnlineUserListPaginator=Paginator.extend({pageName:"aclist",initialize:function(a){Paginator.prototype.initialize.call(this)},onClick:function(a){var b=$(a.target,a.delegateTarget).text();var c=parseInt(b);var d=1;this.model.goTo(c-d);Paginator.prototype.onClick(a)}});window.OnlineUserSearchToolbarView=SearchToolbarView.extend({initialize:function(a){$.extend(this,a);this.defaultSettings({idPrefix:"user",searchable:true,btnNew:false,btnDelete:false});this.render()}});window.OnlineUserToolbarView=Backbone.View.extend({searchable:true,kick_confirm_modal:{},initialize:function(a){$.extend(this,a);this.initEvents()},initEvents:function(){var a=this;this.listenTo(this.targetView.model,"sync reset",function(){a.updateButton()});this.on("kick_confirm",this.onKickConfirm,this)},render:function(){this.$el.html(this.template(this));var a=new OnlineUserSearchToolbarView({targetView:this.targetView,searchTxt:this.searchTxt}).el;var b=$("#search_toolbar",this.$el);b.append(a);var c='<p><span data-i18n="app:message.The kick operation could not be undone">The "kick" operation could not be undone</span></p><p><span data-i18n="app:message.please confirm your intention">please confirm your intention.</span></p>';this.kick_confirm_modal=new ConfirmModalView({modal_id:"kick",confirm_trigger:"kick_confirm",modal_body:c,targetView:this});this.kick_confirm_modal.$el.i18n();this.$el.i18n();return this},events:{"click button#btnKick":"onClickKick","click button#btnRefresh":"onClickRefresh"},updateButton:function(){var a=$("#btnKick");var b=$("#list-area");var c=$("tbody",b);var d=$('input[type="checkbox"]:checked',c);if(d.length>0){a.prop("disabled",false)}else{a.prop("disabled",true)}},onClickKick:function(){$("#modal-area-confirmation").html(this.kick_confirm_modal.el);this.kick_confirm_modal.show()},onClickRefresh:function(){var a=this.targetView;a.fetch()},onKickConfirm:function(){this.targetView.trigger("kick_confirm")}});window.RadiusOnlineUserItemHeaderView=Backbone.View.extend({initialize:function(){this.render()},render:function(){$(this.el).html(this.template(this));return this}});window.ChartsView=Backbone.View.extend({options:{name:"default",height:"250px",width:"100%"},highchart:undefined,highchart_options:{},initialize:function(a){debug.info("Initializing Charts");this.options=$.extend({},this.options,a);this.options.title_prefix=this.options.title;this.options.chart_data_prefix=this.options.chart_data.replace(".json","")},events:{},render:function(){$(this.el).html("<div id="+this.options.name+"></div>");var a=$("#"+this.options.name,$(this.el));a.css("height",this.options.height);a.css("min-width",this.options.width);return this},plot:function(){if(this.highchart_options.chart===undefined){this.highchart_options.chart={}}this.highchart_options.title={text:this.options.title};if(this.options.colors===undefined){this.highchart_options.colors=["#EE7700","#0088DD","#1F3300","#DDDF00","#24CBE5","#64E572","#FF9655","#FFF263","#6AF9C4"]}else{this.highchart_options.colors=this.options.colors}this.highchart_options.chart=$.extend(this.highchart_options.chart,{renderTo:this.options.name});if(this.highchart===undefined)this.highchart=new Highcharts.Chart(this.highchart_options);else this.highchart.redraw();this.fetchData()},fetchData:function(){var a=this;$.ajax({context:this,url:a.options.chart_data,dataType:"json",success:function(b){var c=(b.meta.start-(new Date).getTimezoneOffset()*60)*1e3;var d=b.meta.step*1e3;var e=b.meta.legend.length;if(a.highchart.series.length!=e){while(a.highchart.series.length>0){a.highchart.series.pop()}for(var f=0;f<e;f++){var g={name:b.meta.legend[f]};a.highchart.addSeries(g)}}if(b.data.length>0){while(b.data[b.data.length-1][0]===null){b.data.pop()}}for(var f=0;f<e;f++){var h=[];for(var i=0;i<b.data.length;i++){var j=[c+i*d,b.data[i][f]];h.push(j)}a.highchart.series[f].setData(h)}a.onPlotted()}})},onPlotted:function(){var a=this;setTimeout(function(){a.fetchData()},60*1e3)},formatter:function(a,b){var c;if(a>1e12){c=(a/1e12).toFixed(b)+"T"}else if(a>1e9){c=(a/1e9).toFixed(b)+"G"}else if(a>1e6){c=(a/1e6).toFixed(b)+"M"}else if(a>1e3){c=(a/1e3).toFixed(b)+"k"}else{c=a.toFixed(b)}return c}});window.ChartOnlineUsers=ChartsView.extend({options:{height:"250px"},highchart_options:{chart:{type:"spline",zoomType:"x"},xAxis:{type:"datetime",title:{text:null}},yAxis:{min:0,title:{text:null}},plotOptions:{spline:{lineWidth:2,marker:{enabled:false,radius:2}}},legend:{enabled:false}},onPlotted:function(){var a=this.highchart.series[0];for(i=0;i<a.data.length;i++){this.highchart.series[0].data[i].y=Math.round(a.data[i].y)}ChartsView.prototype.onPlotted.call(this);if(this.options.onlineCountRenderTo!==undefined){var b=$(this.options.onlineCountRenderTo);if(b.length>0){var c=this.highchart.series[0];var d=c.data[c.data.length-1].y;b.html(d)}}}});window.ChartTrafficView=ChartsView.extend({options:{height:"250px"},highchart_options:{chart:{type:"areaspline",zoomType:"x"},xAxis:{type:"datetime",title:{text:null}},yAxis:{min:0,title:{text:"Speed"},labels:{formatter:function(){return ChartsView.prototype.formatter(this.value,0)+"b/s"}}},plotOptions:{areaspline:{lineWidth:2,marker:{enabled:false,radius:2}}},tooltip:{shared:true,formatter:function(){var a='<span style="font-size: x-small;">'+Highcharts.dateFormat("%e %b %Y, %H:%M",this.x)+"</span>";$.each(this.points,function(b,c){a+="<br/>";a+='<span style="color: '+c.series.color+';">'+c.series.name+"</span>: ";a+="<b>"+ChartsView.prototype.formatter(c.y,2)+"b/s</b>"});return a}},credits:{enabled:false},legend:{floating:true,backgroundColor:"#ffffff",shadow:true,verticalAlign:"top",align:"left",x:90,y:35}}});window.KeyValSelect=BackboneCustomModel.extend({idAttribute:"key",toString:function(){return this.attributes.label}});window.SelectCollection=Backbone.Collection.extend({model:KeyValSelect,deferred:null,deferredFetch:function(a){var b=this;if(!this.deferred){this.deferred=$.Deferred(function(a){b.fetch({success:function(){a.resolve()},error:function(b){a.reject(b)}})})}return this.deferred.done(a)},deferredReset:function(){this.deferred=null}});window.Perm=BackboneCustomModel.extend({urlRoot:"/api/perm",isRole:function(a){var b=this.get("roles");for(var c=0;c<b.length;c++){if(b[c]==a)return true}return false},isNoManagementGroup:function(){var a=this.get("mgs");debug.log("MGS",a);return a===undefined||a.length===0},getUsername:function(){return this.get("username")},getFullname:function(){return this.get("fullname")}});window.UserSelect=BackboneCustomModel.extend({idAttribute:"key",toString:function(){return this.attributes.label}});window.UserSelectCollection=SelectCollection.extend({model:UserSelect,url:"/api/user/management/selectlist"});window.UserSelectInstance=new UserSelectCollection;window.ManagementGroup=BackboneCustomModel.extend({urlRoot:"/api/management/group",idAttribute:"_id",schema:{groupname:{type:"Text",title:"management:form.Group name",validators:["required"]},description:{type:"Text",title:"management:form.Description"},groupstatus:{type:"Checkbox",title:"management:form.Active"},members:{type:"List",itemType:"Object",title:"management:form.Members",subSchema:{username:{type:"Select",title:"management:form.Username",options:UserSelectInstance}},itemToString:function(a){debug.log(a);return a.username}}},validate:function(a){var b={};if(!/^[a-zA-Z0-9 _-]+$/.test(a.groupname)){b.groupname=$.t("forms:validation.Value should be the alphanumeric")}if(!_.isEmpty(b))return b},defaults:{groupstatus:true}});window.ManagementGroupCollection=BackboneCustomPaginator.extend({model:ManagementGroup,filter:"{}",paginator_core:{url:"/api/management/group"},paginator_ui:{firstPage:0,currentPage:0,perPage:10,totalPages:1},server_api:{$filter:function(){return this.filter!==undefined?this.filter:"{}"},$top:function(){return this.perPage},$skip:function(){return this.currentPage*this.perPage},$inlinecount:"allpages",$callback:"callback"},parse:function(a){var b=a.results;this.totalPages=Math.ceil(a.__count/this.perPage);debug.info(b);return b}});window.PackageSelectCollection=SelectCollection.extend({url:"/api/package/template/selectlist"});window.PackageSelectInheritCollection=SelectCollection.extend({url:"/api/package/inheritance/selectlist"});window.ManagementGroupSelectCollection=SelectCollection.extend({url:"/api/management/group/selectlist",getById:function(a,b){var c="Unknown";var d=this;for(var e=0;e<d.models.length;e++){var f=d.models[e];if(a==f.get("key")){c=f.get("label")}}return c}});window.PackageSelectInstance=new PackageSelectCollection;window.PackageSelectInheritInstance=new PackageSelectInheritCollection;window.ManagementGroupSelectInstance=new ManagementGroupSelectCollection;window.Package=BackboneCustomModel.extend({urlRoot:function(){var a="/api/package";switch(this.pkgtype){case"template":return a+"/template";case"inheritance":return a+"/inheritance"}return undefined},idAttribute:"_id",schema:{name:{type:"Text",title:"package:form.Name",validators:["required"]},description:{type:"TextArea",title:"package:form.Description"},pkgtype:{type:"Hidden",template:"Hidden"},inherited:{type:"Select",title:"package:form.Policy",options:PackageSelectInstance,validators:["required"]},management_group:{type:"Select",title:"package:form.Management Group",options:ManagementGroupSelectInstance,validators:["required"]},simulteneous_use:{type:"ConcurrentSet",title:"package:form.Concurrent login",validators:[function a(b,c){var d={type:"simulteneous_use",message:"Must greater than 0"};if(b<=0)return d}]},session_timeout:{type:"SessionSet",title:"package:form.Session timeout"},max_all_session:{type:"SessionSet",title:"package:form.All usage"},max_daily_session:{type:"SessionSet",title:"package:form.Daily usage"},max_monthly_session:{type:"SessionSet",title:"package:form.Monthly usage"},max_access_period:{type:"SessionSet",title:"package:form.Access period"},bandwidth_max_up:{type:"BandwidthSet",title:"package:form.Upload"},bandwidth_max_down:{type:"BandwidthSet",title:"package:form.Download"},expiration:{type:"Object",title:"package:form.Expiration",subSchema:{enabled:{type:"Checkbox",title:"Enable"},timestamp:{type:"jqueryui.DateTime",title:""}}},class_of_service:{type:"TextSet",title:"package:form.Class of Service"},packagestatus:{type:"Checkbox",title:"package:form.Active"}},validate:function(a){var b={};if(!/^[a-zA-Z0-9 _-]+$/.test(a.name)){b.name=$.t("forms:validation.Value should be the alphanumeric")}if(!_.isEmpty(b))return b},defaults:{packagestatus:true}});window.PackageCollection=BackboneCustomPaginator.extend({model:Package,filter:"{}",initUrl:function(a){var b="/api/package";switch(a){case"template":b+="/template";break;case"inheritance":b+="/inheritance";break;default:b=undefined}this.paginator_core.url=b},paginator_core:{url:undefined},paginator_ui:{firstPage:0,currentPage:0,perPage:10,totalPages:1},server_api:{$filter:function(){return this.filter!==undefined?this.filter:"{}"},$top:function(){return this.perPage},$skip:function(){return this.currentPage*this.perPage},$inlinecount:"allpages",$callback:"callback"},parse:function(a){var b=a.results;this.totalPages=Math.ceil(a.__count/this.perPage);debug.info(b);return b}});window.User=BackboneCustomModel.extend({urlRoot:"/api/user",bypassUserCheck:false,idAttribute:"_id",schema:{username:{type:"Text",title:"user:form.Username",validators:["required"]},"package":{type:"Select",title:"user:form.Group",options:PackageSelectInheritInstance,validators:["required"]},description:{type:"TextArea",title:"user:form.Description"},roles:{type:"List",title:"user:form.Roles",itemType:"Object",subSchema:{name:{type:"Select",title:"user:form.Roles",options:[{val:"Admin",label:"Admin"}]}},itemToString:function(a){return a.name}},firstname:{type:"Text",title:"user:form.Firstname",validators:["required"]},surname:{type:"Text",title:"user:form.Surname",validators:["required"]},personid:{type:"IDInput",title:"user:form.ID",validators:["required"]},email:{dataType:"email",title:"user:form.Email",validators:["required","email"]},password:{type:"Password",title:"user:form.Password",validators:[{type:"match",field:"password_confirm",message:function(){return $.t("forms:validation.Passwords must match!")}}]},password_confirm:{type:"Password",title:"user:form.Confirm"},macs_binding:{type:"List",title:"user:form.MAC Address",itemType:"Object",subSchema:{mac:{type:"Text",title:"user:form.MAC Address"}},itemToString:function(a){return a.mac}},expiration:{type:"Object",title:"user:form.Expiration",subSchema:{enabled:{type:"Checkbox",title:"user:form.Enable"},timestamp:{type:"jqueryui.DateTime",title:""}}},userstatus:{type:"Checkbox",title:"user:form.Active"},management:{type:"Checkbox",title:"user:form.Management User"}},validate:function(a){var b={};var c=this;if(this.isNew()){if(a.password==="")b.password=$.t("forms:validation.Required")}if(a.password!==undefined&&a.password!==""&&a.password.length<6){b.password=$.t("forms:validation.At least 6 characters length")}function d(a,b){var d=$.t("forms:validation.Username has been taken");if(c.bypassUserCheck||c.get("_id")!==undefined){return}$.ajax({url:"/api/user/check/"+a,dataType:"json",async:false,success:function(a){if(a.username!==undefined){b.username=d}},error:function(a){b.username=d}})}d(a.username,b);function e(c){var d=/^([0-9a-f]{1,2}[\.:-]){5}([0-9a-f]{1,2})$/i;if(!d.test(c)){b.macs_binding=c+" "+$.t("forms:validation.Invalid");return}$.ajax({url:"/api/user/maccheck/"+c,dataType:"json",async:false,success:function(c){if(c.username!==undefined&&c.username!=a.username){var d=permission.isRole("Admin")?c.username:"";b.macs_binding=$.t("user:message.Duplicate MAC Address")+" - "+d}},error:function(a){b.macs_binding=$.t("app:message.Could not get data")}})}_.forEach(a.macs_binding,function(a){e(a.mac)});function f(a){if(a.length!=13)return false;for(i=0,sum=0;i<12;i++){sum+=parseInt(a.charAt(i)*(13-i))}var b=(11-sum%11)%10;return b===parseInt(a.charAt(12))?true:false}if(a.personid!==undefined){var g=a.personid.split(":");if(g.length!=2){b.personid=$.t("forms:validation.Invalid")}else{var h=g[0];var j=g[1];switch(h){case"Thai Personal ID":if(!f(j)){b.personid=$.t("forms:validation.Invalid Thai Personal ID")}break;default:if(j.length<5){b.personid=$.t("forms:validation.Invalid")}}}}else{b.personid=$.t("forms:validation.Invalid")}if(!/^[a-z0-9\\._-]+$/.test(a.username)){b.username=$.t("forms:validation.Value should be the alphanumeric")}if(!_.isEmpty(b))return b},defaults:{userstatus:true}});window.UserImportMeta=BackboneCustomModel.extend({idAttribute:"importid",urlRoot:"/api/user/import/meta"});window.UserImportMetaCollection=Backbone.Collection.extend({url:"/api/user/import/meta",model:UserImportMeta});window.UserImportUser=BackboneCustomModel.extend({idAttribute:"index"});window.UserImportStart=BackboneCustomModel.extend({idAttribute:"importid",id:"xxx",url:function(){return"/api/user/import/meta/"+this.id+"/start"}});window.UserImportProgress=BackboneCustomModel.extend({idAttribute:"importid",id:"xxx",url:function(){return"/api/user/import/meta/"+this.id+"/progress"}});window.UserImportListCollection=Backbone.Collection.extend({importid:"xxx",getfail:false,model:UserImportUser,startIdx:0,url:function(){var a="";var b="";if(this.getfail){a="/verify"}if(this.startIdx>0){b="?start="+this.startIdx}return"/api/user/import/meta/"+this.importid+a+b},setImportID:function(a){this.importid=a},getFailItems:function(a){this.getfail=a},setStartIdx:function(a){this.startIdx=a},parse:function(a){if(this.getfail){debug.info("parse",a);var b=a[a.length-1];this.importCount=b.count;this.importFail=b.fail;a.pop();return a}return a}});window.UserCollection=BackboneCustomPaginator.extend({model:User,filter:"{}",paginator_core:{url:"/api/user"},paginator_ui:{firstPage:0,currentPage:0,perPage:10,totalPages:1},server_api:{$filter:function(){return this.filter!==undefined?this.filter:"{}"},$top:function(){return this.perPage},$skip:function(){return this.currentPage*this.perPage},$inlinecount:"allpages",$callback:"callback"},parse:function(a){var b=a.results;this.totalPages=Math.ceil(a.__count/this.perPage);debug.info(b);return b}});window.AccessCodeMeta=BackboneCustomModel.extend({urlRoot:"/api/accesscode/meta",amountMax:1e3,idAttribute:"_id",schema:{id:{type:"Hidden",title:""},amount:{type:"Number",title:"accesscode:form.Amount",validators:["required"]},"package":{type:"Select",title:"accesscode:form.Group",options:PackageSelectInheritInstance,validators:["required"]},purpose:{type:"TextArea",title:"accesscode:form.Purpose",validators:["required"]},info:{type:"TextArea",title:"accesscode:form.Description"},expiration:{type:"Object",title:"accesscode:form.Expiration",subSchema:{enabled:{type:"Checkbox",title:"Enable"},timestamp:{type:"jqueryui.DateTime",title:""}}}},validate:function(a){var b={};if(a.amount===""||a.amount<1||a.amount>this.amountMax){b.amount=$.t("forms:validation.Value should be in range of 1 to ")+this.amountMax}if(!_.isEmpty(b))return b},defaults:{info:" \n"+"Apply this code in the register page and "+"request for new password"}});window.AccessCodeMetaCollection=BackboneCustomPaginator.extend({model:AccessCodeMeta,filter:"{}",paginator_core:{url:"/api/accesscode/meta"},paginator_ui:{firstPage:0,currentPage:0,perPage:10,totalPages:1},server_api:{$filter:function(){return this.filter!==undefined?this.filter:"{}"},$top:function(){return this.perPage},$skip:function(){return this.currentPage*this.perPage},$inlinecount:"allpages",$callback:"callback"},parse:function(a){var b=a.results;this.totalPages=Math.ceil(a.__count/this.perPage);debug.info(b);return b}});window.AccessCode=BackboneCustomModel.extend({});window.AccessCodeCollection=BackboneCustomPaginator.extend({model:AccessCodeMeta,filter:"{}",paginator_core:{url:"/api/accesscode/code"
},paginator_ui:{firstPage:0,currentPage:0,perPage:20,totalPages:1},server_api:{$filter:function(){return this.filter!==undefined?this.filter:"{}"},$top:function(){return this.perPage},$skip:function(){return this.currentPage*this.perPage},$inlinecount:"allpages",$callback:"callback"},parse:function(a){var b=a.results;this.totalPages=Math.ceil(a.__count/this.perPage);debug.info(b);return b}});window.RadiusOnlineUser=BackboneCustomModel.extend({urlRoot:"/api/user/radius/online",idAttribute:"radacctid"});window.RadiusOnlineUserCollection=BackboneCustomPaginator.extend({model:RadiusOnlineUser,filter:"{}",paginator_core:{url:"/api/user/radius/online"},paginator_ui:{firstPage:0,currentPage:0,perPage:20,totalPages:1},server_api:{$filter:function(){return this.filter!==undefined?this.filter:"{}"},$top:function(){return this.perPage},$skip:function(){return this.currentPage*this.perPage},$inlinecount:"allpages",$callback:"callback"},parse:function(a){var b=a.results;this.totalPages=Math.ceil(a.__count/this.perPage);debug.info(b);return b}});window.DarkSolar={};window.Router=Backbone.Router.extend({routes:{},manager_components:["dashboard","management","package","user","logout"],user_components:["dashboard","logout"],initialize:function(){var a=[];var b=this;window.permission=new Perm;window.oldpermission="";window.forcelogout_modal=null;DarkSolar.MainMenu=new MenuView;function c(){if(window.sio_url!==undefined){window.socket=io(window.sio_url);window.socket.on("probe",function(){socket.emit("ack",{})});window.socket.on("forcelogout",function(a){if(!window.forcelogout_modal){window.forcelogout_modal=new ForceLogoutModalView;$("#content").append(window.forcelogout_modal.el)}window.forcelogout_modal.show()});window.socket.on("updateperm",function(a){console.log(a);window.permission.fetch({success:function(){if(JSON.stringify(window.permission)!=window.oldpermission){document.location.reload(true)}window.oldpermission=JSON.stringify(window.permission)}})})}}window.permission.fetch({success:function(){window.oldpermission=JSON.stringify(window.permission);c();var a=b.user_components;if(permission.isRole("Admin")||!permission.isNoManagementGroup())a=b.manager_components;for(var d=0;d<a.length;d++){var e=b[a[d]+"_routesinit"];if(e){e.call(b)}}debug.info("Components initialized");window.spinner=new DSSpinner;$("#spinner-area").append(spinner.el);Backbone.history.start();$("#nav-home-username").html(window.permission.getUsername());$("#nav-home-fullname").html(window.permission.getFullname());$("body").i18n()}})}});templateLoader.load(["SubNavItemView","DashboardView","MonitorHostView","MonitorNetworkView","ManagementGroupView","ManagementGroupItemView","ManagementGroupItemHeaderView","PackageTemplateView","PackageTemplateItemView","PackageTemplateItemHeaderView","PackageItemView","PackageItemHeaderView","UserView","UserItemView","UserItemHeaderView","UserImportView","UserImportListItemView","UserImportItemHeaderView","UserImportItemView","SearchToolbarView","AccessCodeView","AccessCodeItemView","AccessCodeItemHeaderView","RegisterTrackingView","RegisterTrackingItemView","RegisterTrackingItemHeaderView","RadiusOnlineUserView","RadiusOnlineUserItemView","RadiusOnlineUserItemHeaderView","OnlineUserToolbarView","MainToolbarView","ConfirmModalView","ForceLogoutModalView","AlertMessageView"],function(){$(window).on("app_init_ready",function(){app=new Router;app.on("all",navbarTrack)})});if(production){Backbone.debug.off()}else{Backbone.debug.on()}DarkSolar.formValidatorsTranslation=function(){Backbone.Form.validators.errMessages.required=$.t("forms:validation.Required");Backbone.Form.validators.errMessages.regexp=$.t("forms:validation.Invalid");Backbone.Form.validators.errMessages.email=$.t("forms:validation.Invalid email address");Backbone.Form.validators.errMessages.match=_.template($.t("forms:validation.Must match field")+' "<%= field %>"',null,Backbone.Form.templateSettings)};Router.prototype.dashboard_routesinit=function(){if(permission.isRole("Admin")||!permission.isNoManagementGroup()){this.route("","dashboard");this.route("dashboard","dashboard");this.dashboard_init()}else{this.route("","dashboard_user");this.route("dashboard","dashboard_user");this.dashboard_user_init()}};Router.prototype.dashboard_init=function(){this.dashboardView=new DashboardView;this.dashboardView.render();this.dashboard_nav_init()};Router.prototype.dashboard_user_init=function(){this.dashboard_nav_init()};Router.prototype.dashboard_nav_init=function(){DarkSolar.MainMenu.add("Monitor","","fa fa-users");DarkSolar.MainMenu.add("Monitor/Dashboard","/#/dashboard","fa fa-dashboard")};Router.prototype.dashboard=function(){if(!this.dashboardView){this.dashboardView=new dashboardView;this.dashboardView.render()}else{this.dashboardView.delegateEvents()}$("#content").html(this.dashboardView.el);this.dashboardView.showFirstTab()};Router.prototype.dashboard_user=function(){var a=new UserSelfServiceFormView;$("#content").html(a.render().el);$("#content").append("<br><br><br>");var b=new User;b.schema.package={type:"Hidden"};b.set({_id:permission.attributes._id},{silent:true}).fetch({success:function(){a.trigger("userselected",b)}})};Router.prototype.management_routesinit=function(){if(!permission.isRole("Admin")){return}this.route("management","management_group");this.route("management/group","management_group");this.management_init();debug.info("Management initialized")};Router.prototype.management_init=function(){this.management_nav_init()};Router.prototype.management_nav_init=function(){DarkSolar.MainMenu.add("User Management/Policy/Management Group","/#/management/group","fa fa-user-secret")};Router.prototype.management_group=function(a){var b=new ManagementGroupView;var c=new ManagementGroupFormView;var d=new ManagementGroupListView({targetView:c});c.setTargetView(d);$("#content").html(b.render().el);$("#management-form").html(c.render().el);$("#management-list").html(d.render().el)};Router.prototype.package_routesinit=function(){if(!permission.isRole("Admin")&&permission.isNoManagementGroup())return;this.route("package","package");this.route("package/:page","package");this.package_init()};Router.prototype.package_init=function(){this.package_nav_init()};Router.prototype.package_nav_init=function(){DarkSolar.MainMenu.add("User Management/Policy","","fa fa-sitemap");if(permission.isRole("Admin")){DarkSolar.MainMenu.add("User Management/Policy/Master Policy","/#/package/template","fa fa-sitemap")}DarkSolar.MainMenu.add("User Management/Policy/Group","/#/package","fa fa-users")};Router.prototype.package=function(a){if(a=="template"){if(permission.isRole("Admin")){this.package.template.call(this,a)}}else{this.package.inheritance.call(this,a)}};Router.prototype.package.template=function(a){var b=new PackageTemplateView;var c=new PackageTemplateFormView({pkgtype:"template"});var d=new PackageListView({pkgtype:"template",targetView:c});c.setTargetView(d);$("#content").html(b.render().el);$("#package-header").html("<h1>Policy</h1>");$("#package-list").html(d.render().el);$("#package-form").html(c.render().el);return this};Router.prototype.package.inheritance=function(a){var b=new PackageTemplateView;var c=new PackageInheritanceFormView({pkgtype:"inheritance"});var d=new PackageListView({pkgtype:"inheritance",targetView:c});c.setTargetView(d);$("#content").html(b.render().el);$("#package-header").html("<h1>Package</h1>");$("#package-list").html(d.render().el);$("#package-form").html(c.render().el);return this};Router.prototype.user_routesinit=function(){if(!permission.isRole("Admin")&&permission.isNoManagementGroup())return;this.route("user","user");this.route("user/import","userimport");this.route("user/accesscode","accesscode");this.route("user/registertrack","registertrack");this.route("user/radiusonlineuser","radiusonlineuser");this.user_init()};Router.prototype.user_init=function(){this.user_nav_init()};Router.prototype.user_nav_init=function(){DarkSolar.MainMenu.add("User Management/User","","fa fa-user");DarkSolar.MainMenu.add("User Management/User/Online","/#/user/radiusonlineuser","fa fa-wifi");DarkSolar.MainMenu.add("User Management/User/User","/#/user","fa fa-user");DarkSolar.MainMenu.add("User Management/User/Import","/#/user/import","fa fa-cloud-upload");DarkSolar.MainMenu.add("User Management/User/Access Code","/#/user/accesscode","fa fa-barcode");DarkSolar.MainMenu.add("User Management/User/Register Tracking","/#/user/registertrack","fa fa-list-ul")};Router.prototype.user=function(){var a=new UserView;var b=new UserFormView;var c=new UserListView({targetView:b});b.setTargetView(c);$("#content").html(a.render().el);$("#user-form").html(b.render().el);$("#user-list").html(c.render().el)};Router.prototype.userimport=function(){var a=new UserImportView;$("#content").html(a.render().el)};Router.prototype.accesscode=function(){var a=new AccessCodeView;var b=new AccessCodeFormView;var c=new AccessCodeListView({targetView:b});b.setTargetView(c);$("#content").html(a.render().el);$("#accesscode-form").html(b.render().el);$("#accesscode-list").html(c.render().el)};Router.prototype.registertrack=function(){var a=new RegisterTrackingView;var b=new RegisterTrackingListView;$("#content").html(a.render().el);$("#regtrack-list").html(b.render().el)};Router.prototype.radiusonlineuser=function(){var a=new RadiusOnlineUserView;var b=new RadiusOnlineUserListView;$("#content").html(a.render().el);$("#radonlineuser-list").html(b.render().el)};Router.prototype.logout_routesinit=function(){};